<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Firebase Starter</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar for message list */
        .message-list::-webkit-scrollbar {
            width: 8px;
        }
        .message-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .message-list::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .message-list::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-4 font-sans">

    <div id="app-container" class="w-full max-w-xl bg-white shadow-2xl rounded-xl p-6 md:p-8 space-y-6">
        <h1 class="text-3xl font-bold text-center text-indigo-700">Real-Time Firestore Demo</h1>
        
        <div class="space-y-2 text-sm md:text-base">
            <p id="status" class="font-medium text-center text-sm text-yellow-600 bg-yellow-100 p-2 rounded-lg">Initializing Firebase...</p>
            <p id="user-id" class="text-center break-all text-gray-500">Awaiting Authentication...</p>
        </div>

        <!-- Message Input -->
        <div class="flex flex-col space-y-3">
            <input type="text" id="message-input" placeholder="Type a public message..."
                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
            <button id="send-button" onclick="sendMessage()" disabled
                    class="bg-indigo-600 text-white font-semibold py-3 rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 disabled:bg-indigo-300">
                Save Message to Firestore
            </button>
        </div>

        <!-- Message List -->
        <div class="space-y-3">
            <h2 class="text-xl font-semibold text-gray-700 border-b pb-2">Public Messages (Real-Time)</h2>
            <div id="messages-list" class="message-list h-64 overflow-y-auto bg-gray-50 p-3 rounded-lg border border-gray-200 space-y-2">
                <!-- Messages will be injected here -->
                <p class="text-gray-400 text-center py-4">Loading messages...</p>
            </div>
        </div>
    </div>

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, addDoc, onSnapshot, collection, query, orderBy, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL VARIABLES & FIREBASE SETUP ---
        // MANDATORY: Use environment variables
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        // Expose functions to the global scope so they can be called from HTML
        window.sendMessage = sendMessage;

        const getCollectionPath = () => `/artifacts/${appId}/public/data/messages`;

        const setupFirebase = async () => {
            const statusEl = document.getElementById('status');
            const userIdEl = document.getElementById('user-id');
            const sendButton = document.getElementById('send-button');

            if (Object.keys(firebaseConfig).length === 0) {
                statusEl.textContent = 'Error: Firebase config missing.';
                console.error("Firebase configuration is missing.");
                return;
            }

            try {
                // 1. Initialize Firebase Services
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug'); // Enable logging for debugging

                // 2. Authentication
                await setPersistence(auth, browserSessionPersistence);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // 3. Auth State Listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdEl.textContent = `Current User ID: ${userId}`;
                        statusEl.textContent = 'Status: Authenticated & Ready';
                        sendButton.disabled = false;
                        isAuthReady = true;
                        
                        // Start listening to data once authenticated
                        listenForMessages();
                    } else {
                        // Fallback/Safety in case auth state is unexpected
                        userId = crypto.randomUUID(); 
                        userIdEl.textContent = `Anon ID (Unauthenticated Fallback): ${userId}`;
                        statusEl.textContent = 'Status: Unauthenticated';
                        sendButton.disabled = true;
                        isAuthReady = false;
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization or Authentication failed:", error);
                statusEl.textContent = `Auth Error: ${error.message}`;
            }
        };

        // --- FIRESTORE FUNCTIONS ---

        // Function to send a message
        async function sendMessage() {
            if (!isAuthReady || !userId || !db) {
                console.error("Firebase is not ready or user is not authenticated.");
                document.getElementById('status').textContent = 'Error: Not ready to send data.';
                return;
            }

            const messageInput = document.getElementById('message-input');
            const messageText = messageInput.value.trim();

            if (messageText === "") {
                messageInput.focus();
                return;
            }

            const newMessage = {
                text: messageText,
                userId: userId, // Store the authenticated user's ID
                timestamp: serverTimestamp() // Firestore server timestamp
            };

            try {
                // Add the new message to the public collection
                await addDoc(collection(db, getCollectionPath()), newMessage);
                messageInput.value = ''; // Clear input on success
                console.log("Document successfully written!");

            } catch (e) {
                console.error("Error adding document: ", e);
                document.getElementById('status').textContent = `Save Error: ${e.message}`;
            }
        }

        // Function to listen for real-time changes
        function listenForMessages() {
            if (!isAuthReady || !db) {
                console.error("Cannot listen for messages: DB or Auth not ready.");
                return;
            }

            const messagesList = document.getElementById('messages-list');
            const q = collection(db, getCollectionPath());
            
            // NOTE: orderBy is commented out to comply with the instruction to avoid index issues.
            // You can uncomment orderBy if you are sure about creating Firestore indexes.
            // const messagesQuery = query(q, orderBy("timestamp", "desc"));
            const messagesQuery = query(q);

            // Set up the real-time listener
            onSnapshot(messagesQuery, (snapshot) => {
                let messages = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    messages.push({ ...data, id: doc.id });
                });
                
                // Manually sort in memory since orderBy is often disabled
                messages.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

                renderMessages(messages, messagesList);
            }, (error) => {
                console.error("Error listening to messages:", error);
                messagesList.innerHTML = `<p class="text-red-500 text-center py-4">Error loading messages: ${error.message}</p>`;
            });
        }

        // Function to render messages to the UI
        function renderMessages(messages, container) {
            container.innerHTML = '';
            if (messages.length === 0) {
                container.innerHTML = `<p class="text-gray-400 text-center py-4">No messages yet. Be the first to post!</p>`;
                return;
            }

            messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                const isUser = msg.userId === userId;
                
                // Format timestamp
                let time = 'Saving...';
                if (msg.timestamp && msg.timestamp.toDate) {
                    time = msg.timestamp.toDate().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                }

                messageDiv.className = `p-3 rounded-xl shadow-sm max-w-[90%] ${isUser ? 'bg-indigo-100 self-end ml-auto' : 'bg-white border border-gray-200 mr-auto'}`;
                
                messageDiv.innerHTML = `
                    <p class="text-gray-800 break-words">${msg.text}</p>
                    <div class="mt-1 text-xs ${isUser ? 'text-indigo-600' : 'text-gray-500'} flex justify-between">
                        <span class="font-semibold">${isUser ? 'You' : `User: ${msg.userId.substring(0, 8)}...`}</span>
                        <span class="ml-2">${time}</span>
                    </div>
                `;
                container.appendChild(messageDiv);
            });
            // Scroll to bottom to show latest message
            container.scrollTop = container.scrollHeight;
        }

        // Start the application setup
        window.addEventListener('load', setupFirebase);
    </script>
</body>
</html>
