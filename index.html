<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkMeetCraft - –ü–æ–∏—Å–∫ –∫–æ–º–∞–Ω–¥—ã</title>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: sans-serif;
            background-color: #0d1117; /* –ß–µ—Ä–Ω—ã–π —Ñ–æ–Ω */
            color: #e6edf3;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }
        /* –°–∫—Ä–æ–ª–ª–±–∞—Ä—ã */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #161b22; }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 4px; }
        
        /* –ö–ª–∞—Å—Å –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
        .nav-btn.active {
            background-color: #1f242d; /* –¢–µ–º–Ω–æ-—Å–µ—Ä—ã–π —Ñ–æ–Ω */
            color: #ffffff;
            border-color: #3b82f6; /* –°–∏–Ω—è—è —Ä–∞–º–∫–∞ */
        }
        /* –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–Ω–æ–º Firebase */
        .firebase-disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="flex flex-col md:flex-row h-full">

    <!-- –ë–õ–û–ö –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –ö–†–ò–¢–ò–ß–ï–°–ö–ò–• –û–®–ò–ë–û–ö -->
    <div id="error-display" class="hidden fixed top-0 left-0 w-full bg-red-600 text-white p-4 z-[9999] font-bold text-center"></div>

    <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
    <aside class="w-full md:w-64 bg-[#161b22] border-r border-[#30363d] flex flex-col p-4 z-20">
        <h1 class="text-2xl font-bold text-orange-500 mb-6 tracking-wider">LinkMeetCraft</h1>

        <!-- –ü–∞–Ω–µ–ª—å –≤—Ö–æ–¥–∞ -->
        <div id="auth-box" class="bg-[#0d1117] p-4 rounded-xl border border-[#30363d] mb-4 shadow-lg">
            <!-- –ï—Å–ª–∏ –Ω–µ –≤–æ—à–µ–ª -->
            <div id="login-view">
                <input type="text" id="nickname-input" placeholder="–í–∞—à –Ω–∏–∫–Ω–µ–π–º" class="w-full bg-[#21262d] border border-[#30363d] rounded p-2 text-white mb-2 focus:border-blue-500 outline-none">
                <button data-action="login" id="login-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded transition">–í–æ–π—Ç–∏</button>
            </div>
            <!-- –ï—Å–ª–∏ –≤–æ—à–µ–ª -->
            <div id="user-view" class="hidden">
                <div class="text-gray-400 text-xs">–í—ã –≤–æ—à–ª–∏ –∫–∞–∫:</div>
                <div id="current-nickname" class="text-blue-400 font-bold text-lg truncate"></div>
                <button data-action="logout" id="logout-btn" class="mt-2 text-xs text-red-400 hover:text-red-300 underline">–°–º–µ–Ω–∏—Ç—å –Ω–∏–∫</button>
            </div>
        </div>

        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
        <nav id="main-nav" class="flex-1 space-y-2">
            <button data-view="profiles" class="nav-btn active w-full text-left p-3 rounded hover:bg-[#21262d] text-gray-300 hover:text-white transition flex items-center border border-transparent focus:border-blue-500">
                üìÑ –ê–Ω–∫–µ—Ç—ã
            </button>
            <button data-view="chat" class="nav-btn w-full text-left p-3 rounded hover:bg-[#21262d] text-gray-300 hover:text-white transition flex items-center border border-transparent focus:border-blue-500">
                üí¨ –û–±—â–∏–π —á–∞—Ç
            </button>
            <button data-view="create" class="nav-btn w-full text-left p-3 rounded bg-orange-900/20 text-orange-400 hover:bg-orange-900/40 hover:text-orange-300 transition flex items-center border border-orange-900/50 mt-4">
                ‚ûï –°–æ–∑–¥–∞—Ç—å –∞–Ω–∫–µ—Ç—É
            </button>
        </nav>
    </aside>

    <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å (–ö–æ–Ω—Ç–µ–Ω—Ç) -->
    <main class="flex-1 relative bg-[#0d1117] overflow-hidden flex flex-col">
        
        <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
        <div id="toast" class="absolute top-4 right-4 bg-blue-600 text-white px-6 py-3 rounded shadow-xl transform translate-x-full transition-transform duration-300 z-50"></div>

        <!-- –≠–∫—Ä–∞–Ω: –ê–Ω–∫–µ—Ç—ã -->
        <div id="view-profiles" class="view-section h-full overflow-y-auto p-6">
            <h2 class="text-2xl font-bold text-white mb-4 border-b border-[#30363d] pb-2">–ê–∫—Ç–∏–≤–Ω—ã–µ –∞–Ω–∫–µ—Ç—ã</h2>
            <div id="profiles-container" class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <!-- –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–≥–ª—É—à–µ—á–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è —Ä–µ–∂–∏–º–∞ –±–µ–∑ Firebase -->
                <div class="text-gray-500 col-span-full text-center p-4">
                    <p class="mb-2">–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö. –û—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ.</p>
                    <p class="text-sm">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–æ–π—Ç–∏, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å.</p>
                </div>
                <!-- –ü—Ä–∏–º–µ—Ä –∞–Ω–∫–µ—Ç—ã -->
                <div class="bg-[#1f242d] p-4 rounded-xl border border-[#30363d] shadow-lg">
                    <div class="font-bold text-orange-400 text-lg">–ù—É–∂–µ–Ω Unity-—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è 2D-–∞—Ä–∫–∞–¥—ã</div>
                    <div class="text-sm text-blue-300 mb-2">–ò—â–µ—Ç: –ü—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç Unity/C#</div>
                    <p class="text-gray-300 text-sm mb-3 whitespace-pre-wrap line-clamp-3">–£ –Ω–∞—Å –µ—Å—Ç—å –∫–æ–Ω—Ü–µ–ø—Ç –∏ –∞—Ä—Ç, –∏—â–µ–º —Ç–æ–≥–æ, –∫—Ç–æ —Å–º–æ–∂–µ—Ç –Ω–∞–ø–∏—Å–∞—Ç—å –æ—Å–Ω–æ–≤–Ω—É—é –ª–æ–≥–∏–∫—É. –ü—Ä–æ–µ–∫—Ç –Ω–∞ —ç–Ω—Ç—É–∑–∏–∞–∑–º–µ. –°—Ç–µ–∫: Unity, C#.</p>
                    <div class="text-xs text-gray-500 border-t border-[#30363d] pt-2 flex flex-col sm:flex-row sm:justify-between sm:items-center mt-2 gap-2">
                        <span class="font-medium text-gray-400">–ê–≤—Ç–æ—Ä: –¢–µ—Å—Ç–æ–≤—ã–π–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <button class="copy-link-btn text-xs text-white bg-green-600 hover:bg-green-700 px-3 py-1 rounded-full transition cursor-not-allowed opacity-50">
                                üîó –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É
                            </button>
                            <span class="text-sm text-white bg-blue-700 px-3 py-1 rounded-full">@test_contact</span>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω: –ß–∞—Ç -->
        <div id="view-chat" class="view-section h-full flex flex-col p-4 hidden">
            <h2 class="text-xl font-bold text-white mb-2 border-b border-[#30363d] pb-2">–û–±—â–∏–π —á–∞—Ç</h2>
            <div id="chat-container" class="flex-1 overflow-y-auto space-y-3 mb-4 pr-2">
                <!-- –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–≥–ª—É—à–µ—á–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è —Ä–µ–∂–∏–º–∞ –±–µ–∑ Firebase -->
                <div class="text-center text-gray-600 mt-10">
                    <p class="mb-2">–ß–∞—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.</p>
                    <p>–°–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã, –ø–æ–∫–∞ –Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å Firebase.</p>
                </div>
            </div>
            <div class="flex gap-2">
                <input type="text" id="chat-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." class="flex-1 bg-[#21262d] border border-[#30363d] rounded p-3 text-white focus:border-blue-500 outline-none">
                <button data-action="send-msg" id="send-msg-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 rounded font-bold">></button>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω: –°–æ–∑–¥–∞–Ω–∏–µ –∞–Ω–∫–µ—Ç—ã -->
        <div id="view-create" class="view-section h-full overflow-y-auto p-6 hidden">
            <h2 class="text-2xl font-bold text-orange-500 mb-6">–ù–æ–≤–∞—è –∞–Ω–∫–µ—Ç–∞</h2>
            <form data-action="create-profile" id="create-form" class="max-w-2xl bg-[#161b22] p-6 rounded-xl border border-[#30363d] space-y-4">
                <div>
                    <label class="block text-gray-400 text-sm mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ / –¶–µ–ª—å</label>
                    <input type="text" id="f-title" required class="w-full bg-[#0d1117] border border-[#30363d] rounded p-2 text-white focus:border-orange-500 outline-none">
                </div>
                <div>
                    <label class="block text-gray-400 text-sm mb-1">–ö–æ–≥–æ –∏—â–µ—Ç–µ (–†–æ–ª—å)</label>
                    <input type="text" id="f-role" required class="w-full bg-[#0d1117] border border-[#30363d] rounded p-2 text-white focus:border-orange-500 outline-none">
                </div>
                <div>
                    <label class="block text-gray-400 text-sm mb-1">–û–ø–∏—Å–∞–Ω–∏–µ / –°—Ç–µ–∫</label>
                    <textarea id="f-desc" required rows="4" class="w-full bg-[#0d1117] border border-[#30363d] rounded p-2 text-white focus:border-orange-500 outline-none"></textarea>
                </div>
                <div>
                    <label class="block text-gray-400 text-sm mb-1">–í–∞—à –∫–æ–Ω—Ç–∞–∫—Ç (Telegram/Discord)</label>
                    <input type="text" id="f-contact" required class="w-full bg-[#0d1117] border border-[#30363d] rounded p-2 text-white focus:border-orange-500 outline-none">
                </div>
                <button type="submit" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 rounded mt-4 transition">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
            </form>
        </div>

    </main>

    <!-- –õ–û–í–ï–¶ –û–®–ò–ë–û–ö –°–ö–†–ò–ü–¢–ê –ò –ì–õ–û–ë–ê–õ–¨–ù–ê–Ø –ù–ê–í–ò–ì–ê–¶–ò–Ø -->
    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–∞, –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–æ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥—É–ª—è
        window.app = {
            setView: (viewId) => {
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                const activeView = document.getElementById('view-' + viewId);
                if (activeView) activeView.classList.remove('hidden');

                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                const selectedBtn = document.querySelector(`.nav-btn[data-view="${viewId}"]`);
                if (selectedBtn) selectedBtn.classList.add('active');

                // –ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª —á–∞—Ç–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
                if(viewId === 'chat') {
                    const container = document.getElementById('chat-container');
                    // –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥, –∑–∞—Ç–µ–º —Å–∫—Ä–æ–ª–ª–∏–º
                    setTimeout(() => container.scrollTop = container.scrollHeight, 100); 
                }
            }
        };

        // –õ–æ–≤–µ—Ü –æ—à–∏–±–æ–∫, —á—Ç–æ–±—ã –≤—ã –≤–∏–¥–µ–ª–∏, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫
        window.addEventListener('error', function(e) {
            const display = document.getElementById('error-display');
            if (!display.innerText.includes("–ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï")) { // –ù–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º –Ω–∞—à–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
                 display.innerText = "–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: " + e.message + " (—Å–º. –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π)";
                 display.classList.remove('hidden');
            }
        });
    </script>

    <!-- –°–ö–†–ò–ü–¢ –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø (–ú–æ–¥—É–ª—å) -->
    <script type="module">
        // –ò–ú–ü–û–†–¢–´ FIREBASE
        // –í—Å–µ –∏–º–ø–æ—Ä—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–¥–µ—Å—å, –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è, —á—Ç–æ–±—ã –Ω–µ –≤—ã–∑—ã–≤–∞—Ç—å –æ—à–∏–±–∫—É "Import outside module"
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, updateProfile, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ò –ó–ê–©–ò–¢–ê ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let firebaseConfig = {};
        let isFirebaseReady = false;
        
        try {
            if (typeof __firebase_config === 'string' && __firebase_config.length > 0) {
                firebaseConfig = JSON.parse(__firebase_config);
            }
            
            // –£–õ–¨–¢–†–ê-–ó–ê–©–ò–¢–ê: –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–∞, –ø—Ä–µ–∂–¥–µ —á–µ–º –ø—ã—Ç–∞—Ç—å—Å—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å
            if (firebaseConfig && firebaseConfig.apiKey && firebaseConfig.projectId) {
                isFirebaseReady = true;
            } else {
                 console.warn("Firebase configuration is missing vital keys (apiKey/projectId). Disabling Firebase features.");
                 document.getElementById('error-display').innerText = "–ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –ö–ª—é—á Firebase API –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω. –§—É–Ω–∫—Ü–∏–∏ —á–∞—Ç–∞ –∏ –∞–Ω–∫–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.";
                 document.getElementById('error-display').classList.remove('hidden');
            }
        } catch (e) {
            console.error("Failed to parse __firebase_config.", e);
            document.getElementById('error-display').innerText = "–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Firebase. –§—É–Ω–∫—Ü–∏–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã.";
            document.getElementById('error-display').classList.remove('hidden');
        }
        
        let firebaseApp, auth, db;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        if (isFirebaseReady) {
            firebaseApp = initializeApp(firebaseConfig);
            auth = getAuth(firebaseApp);
            db = getFirestore(firebaseApp);
        }

        // --- –ü–£–¢–ò –ö FIRESTORE ---
        const PATH_PROFILES = `/artifacts/${appId}/public/data/profiles`;
        const PATH_CHAT = `/artifacts/${appId}/public/data/chat`;
        const PATH_USERS = `/artifacts/${appId}/users`;

        let currentUser = null; // –ë—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –æ–±—ä–µ–∫—Ç { uid, displayName }

        // --- –§–£–ù–ö–¶–ò–ò –ò–ù–¢–ï–†–§–ï–ô–°–ê ---

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.style.transform = 'translateX(0)';
            setTimeout(() => toast.style.transform = 'translateX(120%)', 3000);
        }

        function updateAuthUI(user) {
            const loginView = document.getElementById('login-view');
            const userView = document.getElementById('user-view');
            
            if (user && user.displayName) {
                currentUser = user;
                loginView.classList.add('hidden');
                userView.classList.remove('hidden');
                document.getElementById('current-nickname').innerText = user.displayName;
                
                // –í–∫–ª—é—á–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à–µ–ª (–¥–∞–∂–µ –ª–æ–∫–∞–ª—å–Ω–æ)
                document.getElementById('send-msg-btn').classList.remove('firebase-disabled');
                document.querySelector('.nav-btn[data-view="create"]').classList.remove('firebase-disabled');

            } else {
                currentUser = null;
                loginView.classList.remove('hidden');
                userView.classList.add('hidden');

                 // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–æ—à–µ–ª
                document.getElementById('send-msg-btn').classList.add('firebase-disabled');
                document.querySelector('.nav-btn[data-view="create"]').classList.add('firebase-disabled');
            }
        }
        
        function copyToClipboard(text, message) {
            const tempInput = document.createElement('input');
            tempInput.value = text;
            document.body.appendChild(tempInput);
            tempInput.select();
            try {
                document.execCommand('copy');
                showToast(message || "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!");
            } catch (err) {
                showToast("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å.");
                console.error('Copy failed:', err);
            }
            document.body.removeChild(tempInput);
        }

        // --- –õ–û–ì–ò–ö–ê –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò ---

        async function handleLogin() {
            const nick = document.getElementById('nickname-input').value.trim();
            if(nick.length < 3) return showToast("–ù–∏–∫ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π!");
            
            if (isFirebaseReady) {
                // *** –†–ï–ñ–ò–ú FIREBASE (–°–ò–õ–¨–ù–´–ô –í–•–û–î) ***
                try {
                    if (!auth.currentUser) {
                        await signInAnonymously(auth);
                    }
                    
                    const uid = auth.currentUser.uid;
                    const userRef = doc(db, PATH_USERS, uid);
                    const userSnap = await getDoc(userRef);
                    const now = Date.now();

                    let canChange = true;
                    if (userSnap.exists()) {
                        const lastChange = userSnap.data().lastChange || 0;
                        if (now - lastChange < 2592000000) { // 30 –¥–Ω–µ–π
                            const daysLeft = Math.ceil((2592000000 - (now - lastChange)) / (1000 * 60 * 60 * 24));
                            canChange = false;
                            showToast(`–ú–µ–Ω—è—Ç—å –Ω–∏–∫ –º–æ–∂–Ω–æ —Ä–∞–∑ –≤ –º–µ—Å—è—Ü! –û—Å—Ç–∞–ª–æ—Å—å: ${daysLeft} –¥–Ω–µ–π.`);
                        }
                    }
                    
                    if (canChange) {
                        await updateProfile(auth.currentUser, { displayName: nick });
                        await setDoc(userRef, { nickname: nick, lastChange: now, uid: uid }, { merge: true });
                    }
                    
                    updateAuthUI(auth.currentUser);
                    showToast("–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, " + auth.currentUser.displayName);
                    setupFirestoreListeners();

                } catch (e) {
                    console.error("Login error:", e);
                    showToast("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: " + e.message);
                }
            } else {
                 // *** –†–ï–ñ–ò–ú –õ–û–ö–ê–õ–¨–ù–û–ì–û –í–•–û–î–ê (–°–õ–ê–ë–´–ô –í–•–û–î) ***
                const mockUser = {
                    uid: 'mock-' + crypto.randomUUID(),
                    displayName: nick
                };
                
                localStorage.setItem('localNickname', nick);
                localStorage.setItem('localUid', mockUser.uid);

                updateAuthUI(mockUser);
                showToast("–í—ã –≤–æ—à–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ. –û–Ω–ª–∞–π–Ω-—Ñ—É–Ω–∫—Ü–∏–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã.");
                setupFirestoreListeners(); // –í—ã–∑–æ–≤–µ—Ç –∑–∞–≥–ª—É—à–∫–∏
            }
        }

        function handleLogout() {
             localStorage.removeItem('localNickname');
             localStorage.removeItem('localUid');
             
             // –ï—Å–ª–∏ Firebase –∞–∫—Ç–∏–≤–µ–Ω, –ø—Ä–æ—Å—Ç–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º UI (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Å—Ç–∞–µ—Ç—Å—è –∞–Ω–æ–Ω–∏–º–Ω—ã–º)
             if (isFirebaseReady && auth.currentUser) {
                // –î–ª—è Firebase –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤–≤–æ–¥–∞ –Ω–∏–∫–∞
             }
             
             updateAuthUI(null);
             document.getElementById('nickname-input').value = '';
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ: –ø—Ä–æ–≤–µ—Ä—è–µ–º Firebase –∏–ª–∏ Local Storage
        if (isFirebaseReady) {
            onAuthStateChanged(auth, (user) => {
                if (user && user.uid) {
                    if (user.displayName) {
                        updateAuthUI(user);
                        setupFirestoreListeners();
                    } else {
                        updateAuthUI(null); 
                    }
                } else {
                     updateAuthUI(null);
                }
            });
        } else {
             // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –≤—Ö–æ–¥–∞, –µ—Å–ª–∏ Firebase –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω
             const localNick = localStorage.getItem('localNickname');
             const localUid = localStorage.getItem('localUid');
             if (localNick && localUid) {
                 updateAuthUI({ uid: localUid, displayName: localNick });
             } else {
                 updateAuthUI(null);
             }
        }


        // --- –ß–ê–¢ (–ó–ê–ì–õ–£–®–ö–ò/–û–ù–õ–ê–ô–ù) ---

        async function sendMessage() {
            if (!currentUser || !currentUser.displayName) return showToast("–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏.");

            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;

            if (!isFirebaseReady) {
                 showToast("–û—à–∏–±–∫–∞: –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç–∫–ª—é—á–µ–Ω–∞. –ö–ª—é—á API –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω.");
                 return;
            }
            
            // –õ–æ–≥–∏–∫–∞ Firebase
            try {
                input.value = ''; 
                await addDoc(collection(db, PATH_CHAT), {
                    text: text,
                    author: currentUser.displayName,
                    uid: currentUser.uid,
                    createdAt: serverTimestamp()
                });
            } catch (e) {
                showToast("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: " + e.message);
                input.value = text; 
            }
        }

        function setupChatListener() {
            const chatContainer = document.getElementById('chat-container');
            if (!isFirebaseReady) {
                chatContainer.innerHTML = `<div class="text-center text-red-400 mt-10">
                    <p class="mb-2">–ß–∞—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.</p>
                    <p>–°–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã/–ø–æ–ª—É—á–µ–Ω—ã, –ø–æ–∫–∞ –Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å Firebase.</p>
                </div>`;
                return;
            }
            
            // –õ–æ–≥–∏–∫–∞ Firebase
            const qChat = query(collection(db, PATH_CHAT), orderBy('createdAt', 'desc'), limit(50));
            const unsubscribeChat = onSnapshot(qChat, (snapshot) => {
                chatContainer.innerHTML = '';
                const msgs = [];
                snapshot.forEach(d => msgs.push(d.data()));
                msgs.reverse(); 

                msgs.forEach(msg => {
                    const div = document.createElement('div');
                    // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    const isOwn = currentUser && msg.uid === currentUser.uid;
                    div.className = `p-2 rounded max-w-[80%] ${isOwn ? 'bg-blue-900 ml-auto' : 'bg-[#1f242d] mr-auto'}`;
                    div.innerHTML = `<span class="text-blue-400 font-bold text-xs">${msg.author}</span>: <span class="text-gray-300">${msg.text}</span>`;
                    chatContainer.appendChild(div);
                });
                
                if (!document.getElementById('view-chat').classList.contains('hidden')) {
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
            }, (error) => {
                 console.error("Chat listener error:", error);
                 showToast("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–∞.");
            });
            return unsubscribeChat;
        }

        // --- –ê–ù–ö–ï–¢–´ (–ó–ê–ì–õ–£–®–ö–ò/–û–ù–õ–ê–ô–ù) ---

        async function createProfile(e) {
            e.preventDefault();
            if (!currentUser || !currentUser.displayName) return showToast("–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏.");

            if (!isFirebaseReady) {
                 showToast("–û—à–∏–±–∫–∞: –°–æ–∑–¥–∞–Ω–∏–µ –∞–Ω–∫–µ—Ç –æ—Ç–∫–ª—é—á–µ–Ω–æ. –ö–ª—é—á API –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω.");
                 return;
            }

            const title = document.getElementById('f-title').value.trim();
            const role = document.getElementById('f-role').value.trim();
            const desc = document.getElementById('f-desc').value.trim();
            const contact = document.getElementById('f-contact').value.trim();

            if (!title || !role || !desc || !contact) {
                return showToast("–í—Å–µ –ø–æ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã!");
            }

            try {
                await addDoc(collection(db, PATH_PROFILES), {
                    title, role, desc, contact,
                    author: currentUser.displayName,
                    uid: currentUser.uid,
                    createdAt: serverTimestamp()
                });
                showToast("–ê–Ω–∫–µ—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞!");
                e.target.reset();
                window.app.setView('profiles');
            } catch (err) {
                console.error("Create profile error:", err);
                showToast("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞–Ω–∫–µ—Ç—ã: " + err.message);
            }
        }

        function setupProfilesListener() {
            const profilesContainer = document.getElementById('profiles-container');
            
            if (!isFirebaseReady) {
                // –ï—Å–ª–∏ –Ω–µ –≥–æ—Ç–æ–≤—ã, –æ—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç, –Ω–æ –æ—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—É—é –Ω–∞–¥–ø–∏—Å—å –æ –∑–∞–≥—Ä—É–∑–∫–µ
                profilesContainer.querySelector('.text-gray-500').innerHTML = 
                    `<p class="mb-2 text-red-400">–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö. –û—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ.</p>
                    <p class="text-sm">–ß—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å Firebase.</p>`;
                return;
            }
            
            // –õ–æ–≥–∏–∫–∞ Firebase
            const qProfiles = query(collection(db, PATH_PROFILES), orderBy('createdAt', 'desc'), limit(20));

            const unsubscribeProfiles = onSnapshot(qProfiles, (snapshot) => {
                profilesContainer.innerHTML = '';
                if (snapshot.empty) {
                    profilesContainer.innerHTML = '<div class="text-gray-500 col-span-full text-center p-4">–ê–Ω–∫–µ—Ç –ø–æ–∫–∞ –Ω–µ—Ç. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</div>';
                    return;
                }
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const card = document.createElement('div');
                    card.className = "bg-[#1f242d] p-4 rounded-xl border border-[#30363d] hover:border-blue-500 transition shadow-lg";
                    
                    const profileId = doc.id; 
                    const profileURL = `${window.location.origin}${window.location.pathname}?profileId=${profileId}`; 

                    card.innerHTML = `
                        <div class="font-bold text-orange-400 text-lg">${data.title}</div>
                        <div class="text-sm text-blue-300 mb-2">–ò—â–µ—Ç: ${data.role}</div>
                        <p class="text-gray-300 text-sm mb-3 whitespace-pre-wrap line-clamp-3">${data.desc}</p>
                        <div class="text-xs text-gray-500 border-t border-[#30363d] pt-2 flex flex-col sm:flex-row sm:justify-between sm:items-center mt-2 gap-2">
                            <span class="font-medium text-gray-400">–ê–≤—Ç–æ—Ä: ${data.author}</span>
                            <div class="flex flex-col sm:flex-row gap-2">
                                <button data-url="${profileURL}" class="copy-link-btn text-xs text-white bg-green-600 hover:bg-green-700 px-3 py-1 rounded-full transition">
                                    üîó –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É
                                </button>
                                <span class="text-sm text-white bg-blue-700 px-3 py-1 rounded-full">${data.contact}</span>
                            </div>
                        </div>
                    `;
                    
                    card.querySelector('.copy-link-btn').addEventListener('click', (e) => {
                        e.stopPropagation(); 
                        const url = e.currentTarget.getAttribute('data-url');
                        copyToClipboard(url, "–°—Å—ã–ª–∫–∞ –Ω–∞ –∞–Ω–∫–µ—Ç—É —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!");
                    });
                    
                    profilesContainer.appendChild(card);
                });
            }, (error) => {
                 console.error("Profiles listener error:", error);
                 showToast("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∫–µ—Ç.");
            });
            return unsubscribeProfiles;
        }
        
        let unsubscribeListeners = [];

        function setupFirestoreListeners() {
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];
            
            if (currentUser && currentUser.displayName) {
                 const chatUnsub = setupChatListener();
                 if (chatUnsub) unsubscribeListeners.push(chatUnsub);
                 
                 const profilesUnsub = setupProfilesListener();
                 if (profilesUnsub) unsubscribeListeners.push(profilesUnsub);
            }
        }

        // --- –ó–ê–ü–£–°–ö ---
        
        document.addEventListener('DOMContentLoaded', () => {
             // –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    if (e.currentTarget.classList.contains('firebase-disabled') && !currentUser) {
                         return showToast("–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ. –í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é.");
                    }
                    window.app.setView(btn.dataset.view);
                });
            });

            // –ö–Ω–æ–ø–∫–∞ –í—Ö–æ–¥
            document.getElementById('login-btn').addEventListener('click', handleLogin);
            
            // –ö–Ω–æ–ø–∫–∞ –°–º–µ–Ω–∏—Ç—å –Ω–∏–∫
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            
            // –ö–Ω–æ–ø–∫–∞ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
            const sendMsgBtn = document.getElementById('send-msg-btn');
            sendMsgBtn.addEventListener('click', sendMessage);
            if (!isFirebaseReady) sendMsgBtn.classList.add('firebase-disabled'); // –û—Å—Ç–∞–µ—Ç—Å—è disabled, –ø–æ–∫–∞ –Ω–µ –≤–æ—à–µ–ª (–¥–∞–∂–µ –ª–æ–∫–∞–ª—å–Ω–æ)

            document.getElementById('chat-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });

            // –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞–Ω–∫–µ—Ç—ã
            document.getElementById('create-form').addEventListener('submit', createProfile);
            
            window.app.setView('profiles');
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≥–ª—É—à–µ–∫/–¥–∞–Ω–Ω—ã—Ö
            setupFirestoreListeners(); 
        });
    </script>
</body>
</html>
