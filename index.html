<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkMeetCraft - –ü–æ–∏—Å–∫ –∫–æ–º–∞–Ω–¥—ã</title>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: sans-serif;
            background-color: #0d1117; /* –ß–µ—Ä–Ω—ã–π —Ñ–æ–Ω */
            color: #e6edf3;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }
        /* –°–∫—Ä–æ–ª–ª–±–∞—Ä—ã */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #161b22; }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 4px; }
        
        /* –ö–ª–∞—Å—Å –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
        .nav-btn.active {
            background-color: #1f242d; /* –¢–µ–º–Ω–æ-—Å–µ—Ä—ã–π —Ñ–æ–Ω */
            color: #ffffff;
            border-color: #3b82f6; /* –°–∏–Ω—è—è —Ä–∞–º–∫–∞ */
        }
        /* –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –ª–æ–≥–∏–Ω–∞ */
        .logged-out-disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="flex flex-col md:flex-row h-full">

    <!-- –ë–õ–û–ö –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –ö–†–ò–¢–ò–ß–ï–°–ö–ò–• –û–®–ò–ë–û–ö -->
    <div id="error-display" class="hidden fixed top-0 left-0 w-full bg-red-600 text-white p-4 z-[9999] font-bold text-center"></div>
    
    <!-- –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï –û –†–ï–ñ–ò–ú–ï (–¢–û–õ–¨–ö–û –î–õ–Ø –õ–û–ö–ê–õ–¨–ù–û–ì–û –†–ï–ñ–ò–ú–ê) -->
    <div id="mode-warning" class="hidden fixed bottom-0 left-0 right-0 p-2 text-center text-sm font-medium bg-yellow-500 text-yellow-900 z-[999]">
        –ü–†–ò–õ–û–ñ–ï–ù–ò–ï –†–ê–ë–û–¢–ê–ï–¢ –í **–õ–û–ö–ê–õ–¨–ù–û–ú –†–ï–ñ–ò–ú–ï**. –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ. –î–ª—è –æ–±—â–µ–≥–æ —á–∞—Ç–∞ –∏ –∞–Ω–∫–µ—Ç —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Firebase.
    </div>


    <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
    <aside class="w-full md:w-64 bg-[#161b22] border-r border-[#30363d] flex flex-col p-4 z-20">
        <h1 class="text-2xl font-bold text-orange-500 mb-6 tracking-wider">LinkMeetCraft</h1>

        <!-- –ü–∞–Ω–µ–ª—å –≤—Ö–æ–¥–∞ -->
        <div id="auth-box" class="bg-[#0d1117] p-4 rounded-xl border border-[#30363d] mb-4 shadow-lg">
            <!-- –ï—Å–ª–∏ –Ω–µ –≤–æ—à–µ–ª -->
            <div id="login-view">
                <input type="text" id="nickname-input" placeholder="–í–∞—à –Ω–∏–∫–Ω–µ–π–º" class="w-full bg-[#21262d] border border-[#30363d] rounded p-2 text-white mb-2 focus:border-blue-500 outline-none">
                <button data-action="login" id="login-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded transition">–í–æ–π—Ç–∏</button>
            </div>
            <!-- –ï—Å–ª–∏ –≤–æ—à–µ–ª -->
            <div id="user-view" class="hidden">
                <div class="text-gray-400 text-xs">–í—ã –≤–æ—à–ª–∏ –∫–∞–∫:</div>
                <div id="current-nickname" class="text-blue-400 font-bold text-lg truncate"></div>
                <button data-action="logout" id="logout-btn" class="mt-2 text-xs text-red-400 hover:text-red-300 underline">–°–º–µ–Ω–∏—Ç—å –Ω–∏–∫</button>
            </div>
        </div>

        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
        <nav id="main-nav" class="flex-1 space-y-2">
            <button data-view="profiles" class="nav-btn active w-full text-left p-3 rounded hover:bg-[#21262d] text-gray-300 hover:text-white transition flex items-center border border-transparent focus:border-blue-500">
                üìÑ –ê–Ω–∫–µ—Ç—ã
            </button>
            <button data-view="chat" class="nav-btn w-full text-left p-3 rounded hover:bg-[#21262d] text-gray-300 hover:text-white transition flex items-center border border-transparent focus:border-blue-500">
                üí¨ –û–±—â–∏–π —á–∞—Ç
            </button>
            <button data-view="create" class="nav-btn w-full text-left p-3 rounded bg-orange-900/20 text-orange-400 hover:bg-orange-900/40 hover:text-orange-300 transition flex items-center border border-orange-900/50 mt-4 logged-out-disabled">
                ‚ûï –°–æ–∑–¥–∞—Ç—å –∞–Ω–∫–µ—Ç—É
            </button>
        </nav>
    </aside>

    <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å (–ö–æ–Ω—Ç–µ–Ω—Ç) -->
    <main class="flex-1 relative bg-[#0d1117] overflow-hidden flex flex-col">
        
        <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
        <div id="toast" class="absolute top-4 right-4 bg-blue-600 text-white px-6 py-3 rounded shadow-xl transform translate-x-full transition-transform duration-300 z-50"></div>

        <!-- –≠–∫—Ä–∞–Ω: –ê–Ω–∫–µ—Ç—ã -->
        <div id="view-profiles" class="view-section h-full overflow-y-auto p-6">
            <h2 class="text-2xl font-bold text-white mb-4 border-b border-[#30363d] pb-2">–ê–∫—Ç–∏–≤–Ω—ã–µ –∞–Ω–∫–µ—Ç—ã</h2>
            <div id="profiles-container" class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div class="text-gray-500 col-span-full text-center p-4">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω: –ß–∞—Ç -->
        <div id="view-chat" class="view-section h-full flex flex-col p-4 hidden">
            <h2 class="xl font-bold text-white mb-2 border-b border-[#30363d] pb-2">–û–±—â–∏–π —á–∞—Ç</h2>
            <div id="chat-container" class="flex-1 overflow-y-auto space-y-3 mb-4 pr-2">
                <div class="text-center text-gray-600 mt-10">–û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>
            </div>
            <div class="flex gap-2">
                <input type="text" id="chat-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." class="flex-1 bg-[#21262d] border border-[#30363d] rounded p-3 text-white focus:border-blue-500 outline-none">
                <button data-action="send-msg" id="send-msg-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 rounded font-bold logged-out-disabled">></button>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω: –°–æ–∑–¥–∞–Ω–∏–µ –∞–Ω–∫–µ—Ç—ã -->
        <div id="view-create" class="view-section h-full overflow-y-auto p-6 hidden">
            <h2 class="text-2xl font-bold text-orange-500 mb-6">–ù–æ–≤–∞—è –∞–Ω–∫–µ—Ç–∞</h2>
            <form data-action="create-profile" id="create-form" class="max-w-2xl bg-[#161b22] p-6 rounded-xl border border-[#30363d] space-y-4">
                <div>
                    <label class="block text-gray-400 text-sm mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ / –¶–µ–ª—å</label>
                    <input type="text" id="f-title" required class="w-full bg-[#0d1117] border border-[#30363d] rounded p-2 text-white focus:border-orange-500 outline-none">
                </div>
                <div>
                    <label class="block text-gray-400 text-sm mb-1">–ö–æ–≥–æ –∏—â–µ—Ç–µ (–†–æ–ª—å)</label>
                    <input type="text" id="f-role" required class="w-full bg-[#0d1117] border border-[#30363d] rounded p-2 text-white focus:border-orange-500 outline-none">
                </div>
                <div>
                    <label class="block text-gray-400 text-sm mb-1">–û–ø–∏—Å–∞–Ω–∏–µ / –°—Ç–µ–∫</label>
                    <textarea id="f-desc" required rows="4" class="w-full bg-[#0d1117] border border-[#30363d] rounded p-2 text-white focus:border-orange-500 outline-none"></textarea>
                </div>
                <div>
                    <label class="block text-gray-400 text-sm mb-1">–í–∞—à –∫–æ–Ω—Ç–∞–∫—Ç (Telegram/Discord)</label>
                    <input type="text" id="f-contact" required class="w-full bg-[#0d1117] border border-[#30363d] rounded p-2 text-white focus:border-orange-500 outline-none">
                </div>
                <button type="submit" id="create-submit-btn" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 rounded mt-4 transition logged-out-disabled">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
            </form>
        </div>

    </main>

    <!-- –õ–û–í–ï–¶ –û–®–ò–ë–û–ö –°–ö–†–ò–ü–¢–ê –ò –ì–õ–û–ë–ê–õ–¨–ù–ê–Ø –ù–ê–í–ò–ì–ê–¶–ò–Ø -->
    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–∞
        window.app = {
            setView: (viewId) => {
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                const activeView = document.getElementById('view-' + viewId);
                if (activeView) activeView.classList.remove('hidden');

                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                const selectedBtn = document.querySelector(`.nav-btn[data-view="${viewId}"]`);
                if (selectedBtn) selectedBtn.classList.add('active');

                // –ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª —á–∞—Ç–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
                if(viewId === 'chat') {
                    const container = document.getElementById('chat-container');
                    setTimeout(() => container.scrollTop = container.scrollHeight, 100); 
                }
            }
        };

        // –õ–æ–≤–µ—Ü –æ—à–∏–±–æ–∫
        window.addEventListener('error', function(e) {
            const display = document.getElementById('error-display');
            if (!display.innerText.includes("–ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï")) {
                 display.innerText = "–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: " + e.message + " (—Å–º. –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π)";
                 display.classList.remove('hidden');
            }
        });
    </script>

    <!-- –°–ö–†–ò–ü–¢ –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø (–ú–æ–¥—É–ª—å) -->
    <script type="module">
        // –ò–ú–ü–û–†–¢–´ FIREBASE (–¥–ª—è –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)
        let initializeApp, getAuth, signInAnonymously, updateProfile, onAuthStateChanged;
        let getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp, doc, setDoc, getDoc;
        
        // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ò –ó–ê–©–ò–¢–ê ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let firebaseConfig = {};
        let isFirebaseReady = false;
        
        try {
            if (typeof __firebase_config === 'string' && __firebase_config.length > 0) {
                firebaseConfig = JSON.parse(__firebase_config);
            }
            
            if (firebaseConfig && firebaseConfig.apiKey && firebaseConfig.projectId) {
                isFirebaseReady = true;
                
                // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∏–º–ø–æ—Ä—Ç—ã Firebase, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–ª—é—á–∏ –¥–æ—Å—Ç—É–ø–Ω—ã
                import { initializeApp as fbInitApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
                import { getAuth as fbGetAuth, signInAnonymously as fbSignInAnonymously, updateProfile as fbUpdateProfile, onAuthStateChanged as fbOnAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
                import { getFirestore as fbGetFirestore, collection as fbCollection, addDoc as fbAddDoc, query as fbQuery, orderBy as fbOrderBy, limit as fbLimit, onSnapshot as fbOnSnapshot, serverTimestamp as fbServerTimestamp, doc as fbDoc, setDoc as fbSetDoc, getDoc as fbGetDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
                
                initializeApp = fbInitApp; getAuth = fbGetAuth; signInAnonymously = fbSignInAnonymously; updateProfile = fbUpdateProfile; onAuthStateChanged = fbOnAuthStateChanged;
                getFirestore = fbGetFirestore; collection = fbCollection; addDoc = fbAddDoc; query = fbQuery; orderBy = fbOrderBy; limit = fbLimit; onSnapshot = fbOnSnapshot; serverTimestamp = fbServerTimestamp; doc = fbDoc; setDoc = fbSetDoc; getDoc = fbGetDoc;
                
            } else {
                 document.getElementById('mode-warning').classList.remove('hidden');
            }
        } catch (e) {
            console.error("Failed to process Firebase config or imports.", e);
            document.getElementById('error-display').innerText = "–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å Firebase SDK.";
            document.getElementById('error-display').classList.remove('hidden');
        }
        
        let firebaseApp, auth, db;
        
        if (isFirebaseReady) {
            firebaseApp = initializeApp(firebaseConfig);
            auth = getAuth(firebaseApp);
            db = getFirestore(firebaseApp);
        }

        // --- –ü–£–¢–ò –ö FIRESTORE ---
        const PATH_PROFILES = `/artifacts/${appId}/public/data/profiles`;
        const PATH_CHAT = `/artifacts/${appId}/public/data/chat`;
        const PATH_USERS = `/artifacts/${appId}/users`; 

        let currentUser = null; 

        // --- –õ–û–ö–ê–õ–¨–ù–û–ï –•–†–ê–ù–ò–õ–ò–©–ï –î–õ–Ø –†–ï–ñ–ò–ú–ê –ó–ê–ì–õ–£–®–ö–ò ---

        function getLocalData(key, defaultValue = []) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : defaultValue;
            } catch (e) {
                console.error("Error reading localStorage key:", key, e);
                return defaultValue;
            }
        }

        function setLocalData(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (e) {
                console.error("Error writing to localStorage key:", key, e);
                showToast("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ª–æ–∫–∞–ª—å–Ω–æ.");
            }
        }
        
        let localProfiles = getLocalData('lmc_profiles', []);
        let localChat = getLocalData('lmc_chat', []);
        
        // --- –§–£–ù–ö–¶–ò–ò –ò–ù–¢–ï–†–§–ï–ô–°–ê ---

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.style.transform = 'translateX(0)';
            setTimeout(() => toast.style.transform = 'translateX(120%)', 3000);
        }

        function updateAuthUI(user) {
            const loginView = document.getElementById('login-view');
            const userView = document.getElementById('user-view');
            const loggedInControls = document.querySelectorAll('.logged-out-disabled');
            
            if (user && user.displayName) {
                currentUser = user;
                loginView.classList.add('hidden');
                userView.classList.remove('hidden');
                document.getElementById('current-nickname').innerText = user.displayName;
                
                // –í–∫–ª—é—á–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
                loggedInControls.forEach(el => el.classList.remove('logged-out-disabled'));

            } else {
                currentUser = null;
                loginView.classList.remove('hidden');
                userView.classList.add('hidden');

                 // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏
                loggedInControls.forEach(el => el.classList.add('logged-out-disabled'));
            }
        }
        
        function copyToClipboard(text, message) {
            const tempInput = document.createElement('input');
            tempInput.value = text;
            document.body.appendChild(tempInput);
            tempInput.select();
            try {
                document.execCommand('copy');
                showToast(message || "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!");
            } catch (err) {
                showToast("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å.");
                console.error('Copy failed:', err);
            }
            document.body.removeChild(tempInput);
        }

        // --- –õ–û–ì–ò–ö–ê –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò ---

        async function handleLogin() {
            const nick = document.getElementById('nickname-input').value.trim();
            if(nick.length < 3) return showToast("–ù–∏–∫ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π!");
            
            if (isFirebaseReady) {
                // *** –†–ï–ñ–ò–ú FIREBASE (–ü–æ–ª–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å –∫—É–ª–¥–∞—É–Ω–æ–º) ***
                try {
                    if (!auth.currentUser) {
                        await signInAnonymously(auth);
                    }
                    
                    const uid = auth.currentUser.uid;
                    const userRef = doc(db, PATH_USERS, uid);
                    const now = Date.now();
                    
                    let canChange = true;
                    let userData = {};

                    const userSnap = await getDoc(userRef);
                    if (userSnap.exists()) {
                        userData = userSnap.data();
                        const lastChange = userData.lastChange || 0;
                        const COOLDOWN_MS = 2592000000; // 30 –¥–Ω–µ–π –≤ –º—Å
                        
                        if (now - lastChange < COOLDOWN_MS && userData.nickname !== nick) { 
                            const daysLeft = Math.ceil((COOLDOWN_MS - (now - lastChange)) / (1000 * 60 * 60 * 24));
                            canChange = false;
                            showToast(`–ú–µ–Ω—è—Ç—å –Ω–∏–∫ –º–æ–∂–Ω–æ —Ä–∞–∑ –≤ 30 –¥–Ω–µ–π! –û—Å—Ç–∞–ª–æ—Å—å: ${daysLeft} –¥.`);
                            // –ï—Å–ª–∏ –Ω–µ –º–æ–∂–µ–º —Å–º–µ–Ω–∏—Ç—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä—ã–π –Ω–∏–∫
                            await updateProfile(auth.currentUser, { displayName: userData.nickname || 'Anon' });
                        }
                    }
                    
                    if (canChange) {
                        await updateProfile(auth.currentUser, { displayName: nick });
                        await setDoc(userRef, { nickname: nick, lastChange: now, uid: uid }, { merge: true });
                    }
                    
                    updateAuthUI(auth.currentUser);
                    showToast(`–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${auth.currentUser.displayName}`);
                    setupFirestoreListeners();

                } catch (e) {
                    console.error("Login error (Firebase):", e);
                    showToast("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: " + e.message);
                }
            } else {
                 // *** –†–ï–ñ–ò–ú –õ–û–ö–ê–õ–¨–ù–û–ì–û –í–•–û–î–ê ***
                const mockUser = {
                    uid: 'local-' + crypto.randomUUID(),
                    displayName: nick
                };
                
                localStorage.setItem('lmc_nick', nick);
                localStorage.setItem('lmc_uid', mockUser.uid);

                updateAuthUI(mockUser);
                showToast("–í—ã –≤–æ—à–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ. –û–Ω–ª–∞–π–Ω-—Ñ—É–Ω–∫—Ü–∏–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã.");
                setupFirestoreListeners(); 
            }
        }

        function handleLogout() {
             localStorage.removeItem('lmc_nick');
             localStorage.removeItem('lmc_uid');
             
             // –í —Ä–µ–∂–∏–º–µ Firebase (–µ—Å–ª–∏ –∞–∫—Ç–∏–≤–µ–Ω) –ø—Ä–æ—Å—Ç–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º UI 
             if (isFirebaseReady) {
                 // onAuthStateChanged —Å–∞–º –æ–±–Ω–æ–≤–∏—Ç UI –¥–æ anon, –µ—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è
             }
             
             updateAuthUI(null);
             document.getElementById('nickname-input').value = '';

             // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –ª–∏—Å—Ç–µ–Ω–µ—Ä—ã (–≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ - –ø–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä–∏–º)
             setupFirestoreListeners();
        }
        
        // --- –ß–ê–¢ (–ì–ò–ë–†–ò–î) ---

        async function sendMessage() {
            if (!currentUser || !currentUser.displayName) return showToast("–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏.");

            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;
            
            const msgData = {
                text: text,
                author: currentUser.displayName,
                uid: currentUser.uid,
                createdAt: new Date()
            };

            input.value = ''; 

            if (isFirebaseReady) {
                // –õ–æ–≥–∏–∫–∞ Firebase
                try {
                    await addDoc(collection(db, PATH_CHAT), { ...msgData, createdAt: serverTimestamp() });
                } catch (e) {
                    showToast("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: " + e.message);
                    input.value = text; 
                }
            } else {
                 // –õ–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º
                 localChat.push(msgData);
                 setLocalData('lmc_chat', localChat);
                 renderChat(localChat);
            }
        }
        
        function renderChat(msgs) {
            const chatContainer = document.getElementById('chat-container');
            chatContainer.innerHTML = '';
            
            if (msgs.length === 0) {
                 chatContainer.innerHTML = '<div class="text-center text-gray-600 mt-10">–°–æ–æ–±—â–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç.</div>';
                 return;
            }

            msgs.forEach(msg => {
                const div = document.createElement('div');
                const isOwn = currentUser && msg.uid === currentUser.uid;
                div.className = `p-2 rounded max-w-[80%] ${isOwn ? 'bg-blue-900 ml-auto' : 'bg-[#1f242d] mr-auto'}`;
                
                // –í –ª–æ–∫–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ createdAt –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–æ–º Date, –∞ –Ω–µ Firebase Timestamp
                let timeStr;
                if (msg.createdAt instanceof Date) {
                    timeStr = msg.createdAt.toLocaleTimeString();
                } else if (msg.createdAt && msg.createdAt.seconds) {
                    timeStr = new Date(msg.createdAt.seconds * 1000).toLocaleTimeString();
                } else {
                    timeStr = '—Å–µ–π—á–∞—Å';
                }

                div.innerHTML = `<span class="text-blue-400 font-bold text-xs">${msg.author}</span> <span class="text-gray-500 text-xs ml-1">${timeStr}</span>: <span class="text-gray-300">${msg.text}</span>`;
                chatContainer.appendChild(div);
            });
            
            // –ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª
            if (!document.getElementById('view-chat').classList.contains('hidden')) {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        function setupChatListener() {
            if (!currentUser || !currentUser.displayName) {
                document.getElementById('chat-container').innerHTML = '<div class="text-center text-gray-600 mt-10">–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —á–∞—Ç.</div>';
                return;
            }

            if (isFirebaseReady) {
                const qChat = query(collection(db, PATH_CHAT), orderBy('createdAt', 'desc'), limit(50));
                return onSnapshot(qChat, (snapshot) => {
                    const msgs = [];
                    snapshot.forEach(d => msgs.push(d.data()));
                    msgs.reverse(); 
                    renderChat(msgs);
                }, (error) => {
                     console.error("Chat listener error:", error);
                     showToast("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ Firestore.");
                });
            } else {
                // –õ–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º: –ø—Ä–æ—Å—Ç–æ —Ä–µ–Ω–¥–µ—Ä–∏–º, –±–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏
                localChat = getLocalData('lmc_chat', []);
                renderChat(localChat);
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏—è, –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–µ—Ç
                return () => {};
            }
        }

        // --- –ê–ù–ö–ï–¢–´ (–ì–ò–ë–†–ò–î) ---

        async function createProfile(e) {
            e.preventDefault();
            if (!currentUser || !currentUser.displayName) return showToast("–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏.");

            const title = document.getElementById('f-title').value.trim();
            const role = document.getElementById('f-role').value.trim();
            const desc = document.getElementById('f-desc').value.trim();
            const contact = document.getElementById('f-contact').value.trim();

            if (!title || !role || !desc || !contact) {
                return showToast("–í—Å–µ –ø–æ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã!");
            }
            
            const profileData = {
                title, role, desc, contact,
                author: currentUser.displayName,
                uid: currentUser.uid,
                createdAt: new Date(),
                id: crypto.randomUUID()
            };

            if (isFirebaseReady) {
                // –õ–æ–≥–∏–∫–∞ Firebase
                try {
                    await addDoc(collection(db, PATH_PROFILES), { ...profileData, createdAt: serverTimestamp() });
                    showToast("–ê–Ω–∫–µ—Ç–∞ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞!");
                } catch (err) {
                    console.error("Create profile error:", err);
                    showToast("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞–Ω–∫–µ—Ç—ã: " + err.message);
                    return; // –ù–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –ø—Ä–∏ –æ—à–∏–±–∫–µ
                }
            } else {
                 // –õ–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º: –¥–æ–±–∞–≤–ª—è–µ–º –≤ –º–∞—Å—Å–∏–≤
                 // –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ, —á—Ç–æ–±—ã –Ω–æ–≤—ã–µ –∞–Ω–∫–µ—Ç—ã –±—ã–ª–∏ —Å–≤–µ—Ä—Ö—É
                 localProfiles.unshift(profileData); 
                 setLocalData('lmc_profiles', localProfiles);
                 showToast("–ê–Ω–∫–µ—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ!");
                 setupProfilesListener(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
            }
            
            e.target.reset();
            window.app.setView('profiles');
        }

        function renderProfiles(profiles) {
            const profilesContainer = document.getElementById('profiles-container');
            profilesContainer.innerHTML = '';

            if (profiles.length === 0) {
                profilesContainer.innerHTML = '<div class="text-gray-500 col-span-full text-center p-4">–ê–Ω–∫–µ—Ç –ø–æ–∫–∞ –Ω–µ—Ç. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</div>';
                return;
            }

            profiles.forEach(data => {
                const card = document.createElement('div');
                card.className = "bg-[#1f242d] p-4 rounded-xl border border-[#30363d] hover:border-blue-500 transition shadow-lg";
                
                const isLocal = !isFirebaseReady;
                const copyButtonClass = isLocal 
                    ? 'copy-link-btn text-xs text-white bg-green-600/50 px-3 py-1 rounded-full cursor-not-allowed'
                    : 'copy-link-btn text-xs text-white bg-green-600 hover:bg-green-700 px-3 py-1 rounded-full transition';
                const copyButtonText = isLocal ? 'üîó –°—Å—ã–ª–∫–∞ (–õ–æ–∫–∞–ª—å–Ω–æ)' : 'üîó –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É';
                
                const profileURL = isLocal ? '#' : `${window.location.origin}${window.location.pathname}?profileId=${data.id}`; 

                card.innerHTML = `
                    <div class="font-bold text-orange-400 text-lg">${data.title}</div>
                    <div class="text-sm text-blue-300 mb-2">–ò—â–µ—Ç: ${data.role}</div>
                    <p class="text-gray-300 text-sm mb-3 whitespace-pre-wrap line-clamp-3">${data.desc}</p>
                    <div class="text-xs text-gray-500 border-t border-[#30363d] pt-2 flex flex-col sm:flex-row sm:justify-between sm:items-center mt-2 gap-2">
                        <span class="font-medium text-gray-400">–ê–≤—Ç–æ—Ä: ${data.author}</span>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <button data-url="${profileURL}" class="${copyButtonClass}">
                                ${copyButtonText}
                            </button>
                            <span class="text-sm text-white bg-blue-700 px-3 py-1 rounded-full">${data.contact}</span>
                        </div>
                    </div>
                `;
                
                const copyBtn = card.querySelector('.copy-link-btn');
                copyBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    if (isLocal) {
                         showToast("–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ.");
                         return;
                    }
                    const url = e.currentTarget.getAttribute('data-url');
                    copyToClipboard(url, "–°—Å—ã–ª–∫–∞ –Ω–∞ –∞–Ω–∫–µ—Ç—É —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!");
                });
                
                profilesContainer.appendChild(card);
            });
        }

        function setupProfilesListener() {
            if (isFirebaseReady) {
                // –õ–æ–≥–∏–∫–∞ Firebase
                const qProfiles = query(collection(db, PATH_PROFILES), orderBy('createdAt', 'desc'), limit(20));

                return onSnapshot(qProfiles, (snapshot) => {
                    const profiles = [];
                    snapshot.forEach(doc => profiles.push({ id: doc.id, ...doc.data() }));
                    renderProfiles(profiles);

                }, (error) => {
                     console.error("Profiles listener error:", error);
                     showToast("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∫–µ—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.");
                });
            } else {
                // –õ–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º: —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ –Ω–µ —Å–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –ø–æ —Å–µ—Ä–≤–µ—Ä–Ω–æ–º—É Timestamp
                localProfiles = getLocalData('lmc_profiles', []);
                // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
                localProfiles.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                renderProfiles(localProfiles);
                
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏—è, –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–µ—Ç
                return () => {};
            }
        }
        
        let unsubscribeListeners = [];

        function setupFirestoreListeners() {
            // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç —Å—Ç–∞—Ä—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫
            unsubscribeListeners.forEach(unsub => { if (typeof unsub === 'function') unsub(); });
            unsubscribeListeners = [];
            
            const profilesUnsub = setupProfilesListener(); 
            if (profilesUnsub) unsubscribeListeners.push(profilesUnsub);

            // –ß–∞—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ–º, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à–µ–ª
            if (currentUser) {
                 const chatUnsub = setupChatListener();
                 if (chatUnsub) unsubscribeListeners.push(chatUnsub);
            }
        }

        // --- –ó–ê–ü–£–°–ö ---
        
        document.addEventListener('DOMContentLoaded', () => {
             // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
            if (isFirebaseReady) {
                // –†–µ–∂–∏–º Firebase: –∂–¥–µ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
                onAuthStateChanged(auth, (user) => {
                    if (user && user.uid && user.displayName) {
                        updateAuthUI(user);
                        setupFirestoreListeners();
                    } else {
                        updateAuthUI(null); 
                        setupProfilesListener(); 
                    }
                });
            } else {
                 // ** –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –õ–û–ö–ê–õ–¨–ù–´–ô –†–ï–ñ–ò–ú - –£–°–¢–ê–ù–û–í–ö–ê –°–û–°–¢–û–Ø–ù–ò–Ø USER –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï **
                 const localNick = localStorage.getItem('lmc_nick');
                 const localUid = localStorage.getItem('lmc_uid');
                 
                 if (localNick && localUid) {
                     // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º mockUser –≤ currentUser, —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∏ —Ä–∞–±–æ—Ç–∞–ª–∏
                     const mockUser = { uid: localUid, displayName: localNick };
                     updateAuthUI(mockUser);
                 } else {
                     updateAuthUI(null);
                 }
                 setupFirestoreListeners(); // –ó–∞–ø—É—Å–∫–∞–µ–º —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            }

             // –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    if (e.currentTarget.classList.contains('logged-out-disabled') && !currentUser) {
                         return showToast("–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ. –í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é.");
                    }
                    window.app.setView(btn.dataset.view);
                });
            });

            // –ö–Ω–æ–ø–∫–∞ –í—Ö–æ–¥
            document.getElementById('login-btn').addEventListener('click', handleLogin);
            
            // –ö–Ω–æ–ø–∫–∞ –°–º–µ–Ω–∏—Ç—å –Ω–∏–∫
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            
            // –ö–Ω–æ–ø–∫–∞ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
            const sendMsgBtn = document.getElementById('send-msg-btn');
            sendMsgBtn.addEventListener('click', sendMessage);
            document.getElementById('chat-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });

            // –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞–Ω–∫–µ—Ç—ã
            document.getElementById('create-form').addEventListener('submit', createProfile);
            
            window.app.setView('profiles');
        });
    </script>
</body>
</html>
