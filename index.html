<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkMeetCraft - –ü–æ–∏—Å–∫ –∫–æ–º–∞–Ω–¥—ã</title>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* –ß–µ—Ä–Ω—ã–π —Ñ–æ–Ω */
            color: #e6edf3;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }
        /* –°–∫—Ä–æ–ª–ª–±–∞—Ä—ã */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #161b22; }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 4px; }
        
        /* –ö–ª–∞—Å—Å –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
        .nav-btn.active {
            background-color: #1f242d; /* –¢–µ–º–Ω–æ-—Å–µ—Ä—ã–π —Ñ–æ–Ω */
            color: #ffffff;
            border-color: #3b82f6; /* –°–∏–Ω—è—è —Ä–∞–º–∫–∞ */
        }
        /* –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–Ω–æ–º Firebase */
        .firebase-disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>
<body class="flex flex-col md:flex-row h-full">

    <!-- –ë–õ–û–ö –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –ö–†–ò–¢–ò–ß–ï–°–ö–ò–• –û–®–ò–ë–û–ö -->
    <div id="error-display" class="hidden fixed top-0 left-0 w-full bg-red-600 text-white p-4 z-[9999] font-bold text-center"></div>

    <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
    <aside class="w-full md:w-64 bg-[#161b22] border-r border-[#30363d] flex flex-col p-4 z-20">
        <h1 class="text-2xl font-bold text-orange-500 mb-6 tracking-wider">LinkMeetCraft</h1>

        <!-- –ü–∞–Ω–µ–ª—å –≤—Ö–æ–¥–∞ -->
        <div id="auth-box" class="bg-[#0d1117] p-4 rounded-xl border border-[#30363d] mb-4 shadow-lg">
            <!-- –ï—Å–ª–∏ –Ω–µ –≤–æ—à–µ–ª -->
            <div id="login-view">
                <input type="text" id="nickname-input" placeholder="–í–∞—à –Ω–∏–∫–Ω–µ–π–º" class="w-full bg-[#21262d] border border-[#30363d] rounded p-2 text-white mb-2 focus:border-blue-500 outline-none" maxlength="20">
                <button data-action="login" id="login-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded transition">–í–æ–π—Ç–∏</button>
            </div>
            <!-- –ï—Å–ª–∏ –≤–æ—à–µ–ª -->
            <div id="user-view" class="hidden">
                <div class="text-gray-400 text-xs">–í—ã –≤–æ—à–ª–∏ –∫–∞–∫:</div>
                <div id="current-nickname" class="text-blue-400 font-bold text-lg truncate"></div>
                <button data-action="logout" id="logout-btn" class="mt-2 text-xs text-red-400 hover:text-red-300 underline">–°–º–µ–Ω–∏—Ç—å –Ω–∏–∫</button>
            </div>
        </div>

        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
        <nav id="main-nav" class="flex-1 space-y-2">
            <button data-view="profiles" class="nav-btn active w-full text-left p-3 rounded hover:bg-[#21262d] text-gray-300 hover:text-white transition flex items-center border border-transparent focus:border-blue-500">
                üìÑ –ê–Ω–∫–µ—Ç—ã
            </button>
            <button data-view="chat" class="nav-btn w-full text-left p-3 rounded hover:bg-[#21262d] text-gray-300 hover:text-white transition flex items-center border border-transparent focus:border-blue-500">
                üí¨ –û–±—â–∏–π —á–∞—Ç
            </button>
            <button data-view="create" class="nav-btn w-full text-left p-3 rounded bg-orange-900/20 text-orange-400 hover:bg-orange-900/40 hover:text-orange-300 transition flex items-center border border-orange-900/50 mt-4">
                ‚ûï –°–æ–∑–¥–∞—Ç—å –∞–Ω–∫–µ—Ç—É
            </button>
        </nav>
    </aside>

    <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å (–ö–æ–Ω—Ç–µ–Ω—Ç) -->
    <main class="flex-1 relative bg-[#0d1117] overflow-hidden flex flex-col">
        
        <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
        <div id="toast" class="absolute top-4 right-4 bg-blue-600 text-white px-6 py-3 rounded shadow-xl transform translate-x-full transition-transform duration-300 z-50"></div>

        <!-- –≠–∫—Ä–∞–Ω: –ê–Ω–∫–µ—Ç—ã -->
        <div id="view-profiles" class="view-section h-full overflow-y-auto p-6">
            <h2 class="text-2xl font-bold text-white mb-4 border-b border-[#30363d] pb-2">–ê–∫—Ç–∏–≤–Ω—ã–µ –∞–Ω–∫–µ—Ç—ã</h2>
            <div id="profiles-container" class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –≤ JS -->
                <div class="text-gray-500 col-span-full text-center p-4">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö...</div>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω: –ß–∞—Ç -->
        <div id="view-chat" class="view-section h-full flex flex-col p-4 hidden">
            <h2 class="text-xl font-bold text-white mb-2 border-b border-[#30363d] pb-2">–û–±—â–∏–π —á–∞—Ç</h2>
            <div id="chat-container" class="flex-1 overflow-y-auto space-y-3 mb-4 pr-2">
                <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –≤ JS -->
                <div class="text-center text-gray-600 mt-10">–û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>
            </div>
            <div class="flex gap-2">
                <input type="text" id="chat-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." class="flex-1 bg-[#21262d] border border-[#30363d] rounded p-3 text-white focus:border-blue-500 outline-none">
                <button data-action="send-msg" id="send-msg-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 rounded font-bold firebase-disabled transition-colors duration-200">></button>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω: –°–æ–∑–¥–∞–Ω–∏–µ –∞–Ω–∫–µ—Ç—ã -->
        <div id="view-create" class="view-section h-full overflow-y-auto p-6 hidden">
            <h2 class="text-2xl font-bold text-orange-500 mb-6">–ù–æ–≤–∞—è –∞–Ω–∫–µ—Ç–∞</h2>
            <form data-action="create-profile" id="create-form" class="max-w-2xl bg-[#161b22] p-6 rounded-xl border border-[#30363d] space-y-4">
                <div>
                    <label class="block text-gray-400 text-sm mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ / –¶–µ–ª—å</label>
                    <input type="text" id="f-title" required class="w-full bg-[#0d1117] border border-[#30363d] rounded p-2 text-white focus:border-orange-500 outline-none">
                </div>
                <div>
                    <label class="block text-gray-400 text-sm mb-1">–ö–æ–≥–æ –∏—â–µ—Ç–µ (–†–æ–ª—å)</label>
                    <input type="text" id="f-role" required class="w-full bg-[#0d1117] border border-[#30363d] rounded p-2 text-white focus:border-orange-500 outline-none">
                </div>
                <div>
                    <label class="block text-gray-400 text-sm mb-1">–û–ø–∏—Å–∞–Ω–∏–µ / –°—Ç–µ–∫</label>
                    <textarea id="f-desc" required rows="4" class="w-full bg-[#0d1117] border border-[#30363d] rounded p-2 text-white focus:border-orange-500 outline-none"></textarea>
                </div>
                <div>
                    <label class="block text-gray-400 text-sm mb-1">–í–∞—à –∫–æ–Ω—Ç–∞–∫—Ç (Telegram/Discord)</label>
                    <input type="text" id="f-contact" required class="w-full bg-[#0d1117] border border-[#30363d] rounded p-2 text-white focus:border-orange-500 outline-none">
                </div>
                <button type="submit" id="create-submit-btn" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 rounded mt-4 transition firebase-disabled">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
            </form>
        </div>

    </main>

    <!-- –õ–û–í–ï–¶ –û–®–ò–ë–û–ö –°–ö–†–ò–ü–¢–ê –ò –ì–õ–û–ë–ê–õ–¨–ù–ê–Ø –ù–ê–í–ò–ì–ê–¶–ò–Ø -->
    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–∞
        window.app = {
            setView: (viewId) => {
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                const activeView = document.getElementById('view-' + viewId);
                if (activeView) activeView.classList.remove('hidden');

                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                const selectedBtn = document.querySelector(`.nav-btn[data-view="${viewId}"]`);
                if (selectedBtn) selectedBtn.classList.add('active');

                // –ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª —á–∞—Ç–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
                if(viewId === 'chat') {
                    const container = document.getElementById('chat-container');
                    setTimeout(() => container.scrollTop = container.scrollHeight, 100); 
                }
            }
        };

        // –õ–æ–≤–µ—Ü –æ—à–∏–±–æ–∫
        window.addEventListener('error', function(e) {
            const display = document.getElementById('error-display');
            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –æ—à–∏–±–∫—É "Cannot read properties of null (reading 'toMillis')" –Ω–∞ —Å—Ç–∞—Ä—Ç–µ
            if (e.message.includes("toMillis") && e.filename.includes("firebase")) return;
            
            if (!display.innerText.includes("–ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï")) {
                 display.innerText = "–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: " + e.message + " (—Å–º. –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π)";
                 display.classList.remove('hidden');
            }
        });
    </script>

    <!-- –°–ö–†–ò–ü–¢ –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø (–ú–æ–¥—É–ª—å) -->
    <script type="module">
        // –ò–ú–ü–û–†–¢–´ FIREBASE
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, updateProfile, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, limit, onSnapshot, serverTimestamp, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ò –ó–ê–©–ò–¢–ê ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let firebaseConfig = {};
        let isFirebaseReady = false;
        
        try {
            if (typeof __firebase_config === 'string' && __firebase_config.length > 0) {
                firebaseConfig = JSON.parse(__firebase_config);
            }
            
            // –ï—Å–ª–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –µ—Å—Ç—å, –ø—ã—Ç–∞–µ–º—Å—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å
            if (firebaseConfig && firebaseConfig.apiKey && firebaseConfig.projectId) {
                isFirebaseReady = true;
            } else {
                 console.warn("Firebase configuration is missing vital keys. Disabling Firebase features.");
                 document.getElementById('error-display').innerText = "–ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –ö–ª—é—á Firebase API –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω. –§—É–Ω–∫—Ü–∏–∏ —á–∞—Ç–∞ –∏ –∞–Ω–∫–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.";
                 document.getElementById('error-display').classList.remove('hidden');
            }
        } catch (e) {
            console.error("Failed to parse __firebase_config.", e);
            document.getElementById('error-display').innerText = "–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Firebase. –§—É–Ω–∫—Ü–∏–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã.";
            document.getElementById('error-display').classList.remove('hidden');
        }
        
        let firebaseApp, auth, db;
        
        if (isFirebaseReady) {
            firebaseApp = initializeApp(firebaseConfig);
            auth = getAuth(firebaseApp);
            db = getFirestore(firebaseApp);
        }

        // --- –ü–£–¢–ò –ö FIRESTORE (–ø—É–±–ª–∏—á–Ω—ã–µ –∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π) ---
        // –ê–Ω–∫–µ—Ç—ã –∏ —á–∞—Ç ‚Äî –ø—É–±–ª–∏—á–Ω—ã–µ, –¥–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ–º
        const PATH_PROFILES = `/artifacts/${appId}/public/data/profiles`;
        const PATH_CHAT = `/artifacts/${appId}/public/data/chat`;
        // –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–∏–∫–Ω–µ–π–º/–∫—É–ª–¥–∞—É–Ω) ‚Äî –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ, –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const PATH_USERS = `/artifacts/${appId}/users`; 

        let currentUser = null; // –ë—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –æ–±—ä–µ–∫—Ç { uid, displayName }

        // --- –§–£–ù–ö–¶–ò–ò –ò–ù–¢–ï–†–§–ï–ô–°–ê ---

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.style.transform = 'translateX(0)';
            setTimeout(() => toast.style.transform = 'translateX(120%)', 3000);
        }

        function updateAuthUI(user) {
            const loginView = document.getElementById('login-view');
            const userView = document.getElementById('user-view');
            const sendMsgBtn = document.getElementById('send-msg-btn');
            const chatInput = document.getElementById('chat-input');
            const createBtn = document.getElementById('create-submit-btn');
            const createNavBtn = document.querySelector('.nav-btn[data-view="create"]');
            
            if (user && user.displayName) {
                currentUser = user;
                loginView.classList.add('hidden');
                userView.classList.remove('hidden');
                document.getElementById('current-nickname').innerText = user.displayName;
                
                // –í–∫–ª—é—á–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
                sendMsgBtn.classList.remove('firebase-disabled');
                chatInput.disabled = false;
                createBtn.classList.remove('firebase-disabled');
                createNavBtn.classList.remove('firebase-disabled');

            } else {
                currentUser = null;
                loginView.classList.remove('hidden');
                userView.classList.add('hidden');

                // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏
                sendMsgBtn.classList.add('firebase-disabled');
                chatInput.disabled = true;
                createBtn.classList.add('firebase-disabled');
                createNavBtn.classList.add('firebase-disabled');
            }
        }
        
        function copyToClipboard(text, message) {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º document.execCommand('copy') –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –≤ iframe
            const tempInput = document.createElement('input');
            tempInput.value = text;
            document.body.appendChild(tempInput);
            tempInput.select();
            try {
                document.execCommand('copy');
                showToast(message || "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!");
            } catch (err) {
                showToast("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å.");
                console.error('Copy failed:', err);
            }
            document.body.removeChild(tempInput);
        }

        // --- –õ–û–ì–ò–ö–ê –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò (–¢–û–õ–¨–ö–û FIREBASE) ---

        async function handleLogin() {
            const nick = document.getElementById('nickname-input').value.trim();
            if(nick.length < 3) return showToast("–ù–∏–∫ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π!");
            
            if (!isFirebaseReady) {
                 return showToast("–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –≤–æ–π—Ç–∏, –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Firebase –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.");
            }

            try {
                // 1. –û–±–µ—Å–ø–µ—á–∏—Ç—å –∞–Ω–æ–Ω–∏–º–Ω—ã–π –≤—Ö–æ–¥
                if (!auth.currentUser) {
                    await signInAnonymously(auth);
                }
                
                const uid = auth.currentUser.uid;
                const userRef = doc(db, PATH_USERS, uid);
                const now = Date.now();
                
                let canChange = true;
                let userData = {};

                // 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∫—É–ª–¥–∞—É–Ω –Ω–∞ —Å–º–µ–Ω—É –Ω–∏–∫–∞ (30 –¥–Ω–µ–π)
                const userSnap = await getDoc(userRef);
                if (userSnap.exists()) {
                    userData = userSnap.data();
                    const lastChange = userData.lastChange || 0;
                    const COOLDOWN_MS = 2592000000; // 30 –¥–Ω–µ–π –≤ –º—Å
                    
                    // –ï—Å–ª–∏ –Ω–∏–∫ –Ω–µ –º–µ–Ω—è–ª—Å—è, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∫—É–ª–¥–∞—É–Ω
                    if (userData.nickname === nick && auth.currentUser.displayName === nick) {
                        canChange = false; 
                    } else if (now - lastChange < COOLDOWN_MS) { 
                        const daysLeft = Math.ceil((COOLDOWN_MS - (now - lastChange)) / (1000 * 60 * 60 * 24));
                        canChange = false;
                        showToast(`–ú–µ–Ω—è—Ç—å –Ω–∏–∫ –º–æ–∂–Ω–æ —Ä–∞–∑ –≤ 30 –¥–Ω–µ–π! –û—Å—Ç–∞–ª–æ—Å—å: ${daysLeft} –¥.`);
                    }
                }
                
                // 3. –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
                if (canChange || !userSnap.exists()) {
                    await updateProfile(auth.currentUser, { displayName: nick });
                    await setDoc(userRef, { 
                        nickname: nick, 
                        lastChange: now, 
                        uid: uid 
                    }, { merge: true });
                } else if (auth.currentUser.displayName !== userData.nickname) {
                     // –ï—Å–ª–∏ —Å–º–µ–Ω–∏—Ç—å –Ω–∏–∫ –Ω–µ–ª—å–∑—è, –Ω–æ —Ç–µ–∫—É—â–∏–π –≤ Auth –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π
                     await updateProfile(auth.currentUser, { displayName: userData.nickname || 'Anon' });
                }
                
                // 4. –§–∏–Ω–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                updateAuthUI(auth.currentUser);
                showToast(`–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${auth.currentUser.displayName}`);
                setupFirestoreListeners();

            } catch (e) {
                console.error("Login error:", e);
                showToast("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: " + e.message);
            }
        }

        function handleLogout() {
            // –ü—Ä–æ—Å—Ç–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º UI
            updateAuthUI(null);
            document.getElementById('nickname-input').value = '';
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–∏—Å—Ç–µ–Ω–µ—Ä—ã (–∫—Ä–æ–º–µ –ø—É–±–ª–∏—á–Ω—ã—Ö –∞–Ω–∫–µ—Ç)
            unsubscribeListeners.forEach(unsub => { if (typeof unsub === 'function') unsub(); });
            unsubscribeListeners = [];
            
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∞–Ω–∫–µ—Ç—ã
            setupProfilesListener(); 
        }
        
        // --- –ß–ê–¢ ---

        async function sendMessage() {
            if (!currentUser || !currentUser.displayName) return showToast("–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏.");

            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;
            
            // –õ–æ–≥–∏–∫–∞ Firebase
            try {
                input.value = ''; 
                await addDoc(collection(db, PATH_CHAT), {
                    text: text,
                    author: currentUser.displayName,
                    uid: currentUser.uid,
                    createdAt: serverTimestamp()
                });
            } catch (e) {
                showToast("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: " + e.message);
                input.value = text; 
            }
        }

        function setupChatListener() {
            const chatContainer = document.getElementById('chat-container');
            
            if (!currentUser || !currentUser.displayName) {
                chatContainer.innerHTML = '<div class="text-center text-gray-600 mt-10">–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —á–∞—Ç.</div>';
                return;
            }

            // –õ–æ–≥–∏–∫–∞ Firebase
            // –£–±–∏—Ä–∞–µ–º orderBy –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–∞, —Å–æ—Ä—Ç–∏—Ä—É–µ–º –≤ JS.
            const qChat = query(collection(db, PATH_CHAT), limit(50));
            
            const unsubscribeChat = onSnapshot(qChat, (snapshot) => {
                chatContainer.innerHTML = '';
                
                let msgs = [];
                snapshot.forEach(d => {
                    const data = d.data();
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º toMillis() –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏.
                    const timestamp = data.createdAt ? data.createdAt.toMillis() : Date.now();
                    msgs.push({ ...data, timestamp });
                });
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Ä—É—á–Ω—É—é –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (–ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é, —á—Ç–æ–±—ã –Ω–æ–≤—ã–µ –±—ã–ª–∏ –≤–Ω–∏–∑—É)
                msgs.sort((a, b) => a.timestamp - b.timestamp);

                msgs.forEach(msg => {
                    const div = document.createElement('div');
                    const isOwn = currentUser && msg.uid === currentUser.uid;
                    div.className = `p-2 rounded max-w-[80%] ${isOwn ? 'bg-blue-900 ml-auto' : 'bg-[#1f242d] mr-auto'}`;
                    div.innerHTML = `<span class="text-blue-400 font-bold text-xs">${msg.author}</span>: <span class="text-gray-300">${msg.text}</span>`;
                    chatContainer.appendChild(div);
                });
                
                if (!document.getElementById('view-chat').classList.contains('hidden')) {
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
            }, (error) => {
                 console.error("Chat listener error:", error);
                 showToast("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ Firestore.");
            });
            return unsubscribeChat;
        }

        // --- –ê–ù–ö–ï–¢–´ ---

        async function createProfile(e) {
            e.preventDefault();
            if (!currentUser || !currentUser.displayName) return showToast("–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏.");

            const title = document.getElementById('f-title').value.trim();
            const role = document.getElementById('f-role').value.trim();
            const desc = document.getElementById('f-desc').value.trim();
            const contact = document.getElementById('f-contact').value.trim();

            if (!title || !role || !desc || !contact) {
                return showToast("–í—Å–µ –ø–æ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã!");
            }

            // –õ–æ–≥–∏–∫–∞ Firebase
            try {
                await addDoc(collection(db, PATH_PROFILES), {
                    title, role, desc, contact,
                    author: currentUser.displayName,
                    uid: currentUser.uid,
                    createdAt: serverTimestamp()
                });
                showToast("–ê–Ω–∫–µ—Ç–∞ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞!");
                e.target.reset();
                window.app.setView('profiles');
            } catch (err) {
                console.error("Create profile error:", err);
                showToast("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞–Ω–∫–µ—Ç—ã: " + err.message);
            }
        }

        function renderProfiles(profiles) {
            const profilesContainer = document.getElementById('profiles-container');
            profilesContainer.innerHTML = '';

            if (profiles.length === 0) {
                profilesContainer.innerHTML = '<div class="text-gray-500 col-span-full text-center p-4">–ê–Ω–∫–µ—Ç –ø–æ–∫–∞ –Ω–µ—Ç. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</div>';
                return;
            }

            profiles.forEach(data => {
                const card = document.createElement('div');
                card.className = "bg-[#1f242d] p-4 rounded-xl border border-[#30363d] hover:border-blue-500 transition shadow-lg";
                
                const profileId = data.id; 
                // –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É, –∫–æ—Ç–æ—Ä—É—é –º–æ–∂–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏ –ø–æ–¥–µ–ª–∏—Ç—å—Å—è
                const profileURL = `${window.location.origin}${window.location.pathname}?profileId=${profileId}`; 
                
                card.innerHTML = `
                    <div class="font-bold text-orange-400 text-lg">${data.title}</div>
                    <div class="text-sm text-blue-300 mb-2">–ò—â–µ—Ç: ${data.role}</div>
                    <p class="text-gray-300 text-sm mb-3 whitespace-pre-wrap line-clamp-3">${data.desc}</p>
                    <div class="text-xs text-gray-500 border-t border-[#30363d] pt-2 flex flex-col sm:flex-row sm:justify-between sm:items-center mt-2 gap-2">
                        <span class="font-medium text-gray-400">–ê–≤—Ç–æ—Ä: ${data.author}</span>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <button data-url="${profileURL}" class="copy-link-btn text-xs text-white bg-green-600 hover:bg-green-700 px-3 py-1 rounded-full transition">
                                üîó –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É
                            </button>
                            <span class="text-sm text-white bg-blue-700 px-3 py-1 rounded-full whitespace-nowrap">${data.contact}</span>
                        </div>
                    </div>
                `;
                
                const copyBtn = card.querySelector('.copy-link-btn');
                copyBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    const url = e.currentTarget.getAttribute('data-url');
                    copyToClipboard(url, "–°—Å—ã–ª–∫–∞ –Ω–∞ –∞–Ω–∫–µ—Ç—É —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!");
                });
                
                profilesContainer.appendChild(card);
            });
        }

        function setupProfilesListener() {
            const profilesContainer = document.getElementById('profiles-container');
            profilesContainer.innerHTML = '<div class="text-gray-500 col-span-full text-center p-4">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö...</div>';

            if (!isFirebaseReady) {
                 profilesContainer.innerHTML = '<div class="text-red-500 col-span-full text-center p-4">–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å Firebase. –ê–Ω–∫–µ—Ç—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.</div>';
                 return;
            }
            
            // –õ–æ–≥–∏–∫–∞ Firebase
            // –£–±–∏—Ä–∞–µ–º orderBy –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–∞, —Å–æ—Ä—Ç–∏—Ä—É–µ–º –≤ JS.
            const qProfiles = query(collection(db, PATH_PROFILES), limit(20));

            const unsubscribeProfiles = onSnapshot(qProfiles, (snapshot) => {
                let profiles = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º toMillis() –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏.
                    const timestamp = data.createdAt ? data.createdAt.toMillis() : Date.now();
                    profiles.push({ id: doc.id, ...data, timestamp });
                });
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Ä—É—á–Ω—É—é (–ø–æ —É–±—ã–≤–∞–Ω–∏—é, —á—Ç–æ–±—ã –Ω–æ–≤—ã–µ –±—ã–ª–∏ –≤–≤–µ—Ä—Ö—É)
                profiles.sort((a, b) => b.timestamp - a.timestamp);
                
                renderProfiles(profiles);

            }, (error) => {
                 console.error("Profiles listener error:", error);
                 profilesContainer.innerHTML = '<div class="text-red-500 col-span-full text-center p-4">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∫–µ—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.</div>';
                 showToast("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∫–µ—Ç.");
            });
            return unsubscribeProfiles;
        }
        
        let unsubscribeListeners = [];

        function setupFirestoreListeners() {
            // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç —Å—Ç–∞—Ä—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫
            unsubscribeListeners.forEach(unsub => { if (typeof unsub === 'function') unsub(); });
            unsubscribeListeners = [];
            
            // –ê–Ω–∫–µ—Ç—ã –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
            const profilesUnsub = setupProfilesListener(); 
            if (profilesUnsub) unsubscribeListeners.push(profilesUnsub);

            // –ß–∞—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ–º, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à–µ–ª
            if (currentUser && currentUser.displayName) {
                 const chatUnsub = setupChatListener();
                 if (chatUnsub) unsubscribeListeners.push(chatUnsub);
            }
        }

        // --- –ó–ê–ü–£–°–ö ---
        
        document.addEventListener('DOMContentLoaded', () => {
            if (isFirebaseReady) {
                 // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ: –ø—Ä–æ–≤–µ—Ä—è–µ–º Firebase Auth status
                 onAuthStateChanged(auth, (user) => {
                    if (user && user.uid) {
                        if (user.displayName) {
                            updateAuthUI(user);
                            setupFirestoreListeners();
                        } else {
                            // –ê–Ω–æ–Ω–∏–º–Ω—ã–π –≤—Ö–æ–¥ –±–µ–∑ –∏–º–µ–Ω–∏: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞
                            updateAuthUI(null); 
                            setupProfilesListener(); // –ê–Ω–∫–µ—Ç—ã –ø—É–±–ª–∏—á–Ω—ã–µ
                        }
                    } else {
                        // –ù–µ –≤–æ—à–µ–ª
                         updateAuthUI(null); 
                         setupProfilesListener(); // –ê–Ω–∫–µ—Ç—ã –ø—É–±–ª–∏—á–Ω—ã–µ
                    }
                 });
            } else {
                // –ï—Å–ª–∏ Firebase –Ω–µ –≥–æ—Ç–æ–≤, –Ω—É–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ—à–∏–±–∫—É –≤ –∞–Ω–∫–µ—Ç–∞—Ö
                setupProfilesListener();
            }

             // –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    if (e.currentTarget.classList.contains('firebase-disabled') && !currentUser) {
                         return showToast("–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ. –í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é.");
                    }
                    window.app.setView(btn.dataset.view);
                });
            });

            // –ö–Ω–æ–ø–∫–∞ –í—Ö–æ–¥
            document.getElementById('login-btn').addEventListener('click', handleLogin);
            
            // –ö–Ω–æ–ø–∫–∞ –°–º–µ–Ω–∏—Ç—å –Ω–∏–∫
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            
            // –ö–Ω–æ–ø–∫–∞ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
            const sendMsgBtn = document.getElementById('send-msg-btn');
            sendMsgBtn.addEventListener('click', sendMessage);
            document.getElementById('chat-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });

            // –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞–Ω–∫–µ—Ç—ã
            document.getElementById('create-form').addEventListener('submit', createProfile);
            
            window.app.setView('profiles');
        });
    </script>
</body>
</html>
