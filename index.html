<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkMeetCraft - –ü–æ–∏—Å–∫ –∫–æ–º–∞–Ω–¥—ã</title>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: sans-serif;
            background-color: #0d1117; /* –ß–µ—Ä–Ω—ã–π —Ñ–æ–Ω */
            color: #e6edf3;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }
        /* –°–∫—Ä–æ–ª–ª–±–∞—Ä—ã */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #161b22; }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 4px; }
        
        .spinner {
            border: 3px solid rgba(255,255,255,0.1);
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex flex-col md:flex-row h-full">

    <!-- –ë–õ–û–ö –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –û–®–ò–ë–û–ö (–ß—Ç–æ–±—ã –≤—ã –≤–∏–¥–µ–ª–∏, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ —Å–ª–æ–º–∞–ª–æ—Å—å) -->
    <div id="error-display" class="hidden fixed top-0 left-0 w-full bg-red-600 text-white p-4 z-[9999] font-bold text-center"></div>

    <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
    <aside class="w-full md:w-64 bg-[#161b22] border-r border-[#30363d] flex flex-col p-4 z-20">
        <h1 class="text-2xl font-bold text-orange-500 mb-6 tracking-wider">LinkMeetCraft</h1>

        <!-- –ü–∞–Ω–µ–ª—å –≤—Ö–æ–¥–∞ -->
        <div id="auth-box" class="bg-[#0d1117] p-4 rounded-xl border border-[#30363d] mb-4 shadow-lg">
            <!-- –ï—Å–ª–∏ –Ω–µ –≤–æ—à–µ–ª -->
            <div id="login-view">
                <input type="text" id="nickname-input" placeholder="–í–∞—à –Ω–∏–∫–Ω–µ–π–º" class="w-full bg-[#21262d] border border-[#30363d] rounded p-2 text-white mb-2 focus:border-blue-500 outline-none">
                <button id="login-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded transition">–í–æ–π—Ç–∏</button>
            </div>
            <!-- –ï—Å–ª–∏ –≤–æ—à–µ–ª -->
            <div id="user-view" class="hidden">
                <div class="text-gray-400 text-xs">–í—ã –≤–æ—à–ª–∏ –∫–∞–∫:</div>
                <div id="current-nickname" class="text-blue-400 font-bold text-lg truncate">User</div>
                <button id="logout-btn" class="mt-2 text-xs text-red-400 hover:text-red-300 underline">–°–º–µ–Ω–∏—Ç—å –Ω–∏–∫</button>
            </div>
        </div>

        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
        <nav class="flex-1 space-y-2">
            <button onclick="app.setView('profiles')" class="nav-btn w-full text-left p-3 rounded hover:bg-[#21262d] text-gray-300 hover:text-white transition flex items-center border border-transparent focus:border-blue-500">
                üìÑ –ê–Ω–∫–µ—Ç—ã
            </button>
            <button onclick="app.setView('chat')" class="nav-btn w-full text-left p-3 rounded hover:bg-[#21262d] text-gray-300 hover:text-white transition flex items-center border border-transparent focus:border-blue-500">
                üí¨ –û–±—â–∏–π —á–∞—Ç
            </button>
            <button onclick="app.setView('create')" class="nav-btn w-full text-left p-3 rounded bg-orange-900/20 text-orange-400 hover:bg-orange-900/40 hover:text-orange-300 transition flex items-center border border-orange-900/50 mt-4">
                ‚ûï –°–æ–∑–¥–∞—Ç—å –∞–Ω–∫–µ—Ç—É
            </button>
        </nav>
    </aside>

    <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å (–ö–æ–Ω—Ç–µ–Ω—Ç) -->
    <main class="flex-1 relative bg-[#0d1117] overflow-hidden flex flex-col">
        
        <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
        <div id="toast" class="absolute top-4 right-4 bg-blue-600 text-white px-6 py-3 rounded shadow-xl transform translate-x-full transition-transform duration-300 z-50"></div>

<!-- –≠–∫—Ä–∞–Ω: –ê–Ω–∫–µ—Ç—ã -->
        <div id="view-profiles" class="view-section h-full overflow-y-auto p-6 hidden">
            <h2 class="text-2xl font-bold text-white mb-4 border-b border-[#30363d] pb-2">–ê–∫—Ç–∏–≤–Ω—ã–µ –∞–Ω–∫–µ—Ç—ã</h2>
            <div id="profiles-container" class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div class="text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∫–µ—Ç...</div>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω: –ß–∞—Ç -->
        <div id="view-chat" class="view-section h-full flex flex-col p-4 hidden">
            <h2 class="text-xl font-bold text-white mb-2 border-b border-[#30363d] pb-2">–û–±—â–∏–π —á–∞—Ç</h2>
            <div id="chat-container" class="flex-1 overflow-y-auto space-y-3 mb-4 pr-2">
                <div class="text-center text-gray-600 mt-10">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>
            </div>
            <div class="flex gap-2">
                <input type="text" id="chat-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." class="flex-1 bg-[#21262d] border border-[#30363d] rounded p-3 text-white focus:border-blue-500 outline-none">
                <button id="send-msg-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 rounded font-bold">></button>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω: –°–æ–∑–¥–∞–Ω–∏–µ –∞–Ω–∫–µ—Ç—ã -->
        <div id="view-create" class="view-section h-full overflow-y-auto p-6 hidden">
            <h2 class="text-2xl font-bold text-orange-500 mb-6">–ù–æ–≤–∞—è –∞–Ω–∫–µ—Ç–∞</h2>
            <form id="create-form" class="max-w-2xl bg-[#161b22] p-6 rounded-xl border border-[#30363d] space-y-4">
                <div>
                    <label class="block text-gray-400 text-sm mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ / –¶–µ–ª—å</label>
                    <input type="text" id="f-title" required class="w-full bg-[#0d1117] border border-[#30363d] rounded p-2 text-white focus:border-orange-500 outline-none">
                </div>
                <div>
                    <label class="block text-gray-400 text-sm mb-1">–ö–æ–≥–æ –∏—â–µ—Ç–µ (–†–æ–ª—å)</label>
                    <input type="text" id="f-role" required class="w-full bg-[#0d1117] border border-[#30363d] rounded p-2 text-white focus:border-orange-500 outline-none">
                </div>
                <div>
                    <label class="block text-gray-400 text-sm mb-1">–û–ø–∏—Å–∞–Ω–∏–µ / –°—Ç–µ–∫</label>
                    <textarea id="f-desc" required rows="4" class="w-full bg-[#0d1117] border border-[#30363d] rounded p-2 text-white focus:border-orange-500 outline-none"></textarea>
                </div>
                <div>
                    <label class="block text-gray-400 text-sm mb-1">–í–∞—à –∫–æ–Ω—Ç–∞–∫—Ç (Telegram/Discord)</label>
                    <input type="text" id="f-contact" required class="w-full bg-[#0d1117] border border-[#30363d] rounded p-2 text-white focus:border-orange-500 outline-none">
                </div>
                <button type="submit" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 rounded mt-4 transition">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
            </form>
        </div>

    </main>

    <!-- –õ–û–í–ï–¶ –û–®–ò–ë–û–ö –°–ö–†–ò–ü–¢–ê -->
    <script>
        window.addEventListener('error', function(e) {
            const display = document.getElementById('error-display');
            display.innerText = "–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: " + e.message;
            display.classList.remove('hidden');
        });
    </script>

    <!-- –°–ö–†–ò–ü–¢ –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, updateProfile, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp, doc, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        window.app = {
            setView: (viewId) => {
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                document.getElementById('view-' + viewId).classList.remove('hidden');
                
                // –ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª —á–∞—Ç–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
                if(viewId === 'chat') {
                    const container = document.getElementById('chat-container');
                    setTimeout(() => container.scrollTop = container.scrollHeight, 100);
                }
            }
        };

        // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
        const appId = typeof app_id !== 'undefined' ? app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof firebase_config !== 'undefined' ? firebase_config : '{}');
        
        // --- –í–ù–ò–ú–ê–ù–ò–ï: –ó–î–ï–°–¨ –ë–´–õ–ê –û–®–ò–ë–ö–ê. –ù–ï –£–î–ê–õ–Ø–ô–¢–ï –û–ë–†–ê–¢–ù–´–ï –ö–ê–í–´–ß–ö–ò () –í–û–ö–†–£–ì –ü–£–¢–ï–ô! ---
        const PATH_PROFILES = /artifacts/${appId}/public/data/profiles;
        const PATH_CHAT = /artifacts/${appId}/public/data/chat;
        const PATH_USERS = /artifacts/${appId}/users`;
        // -------------------------------------------------------------------------------------

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        const firebaseApp = initializeApp(firebaseConfig);
        const auth = getAuth(firebaseApp);
        const db = getFirestore(firebaseApp);

        let currentUser = null;

        // --- –§–£–ù–ö–¶–ò–ò –ò–ù–¢–ï–†–§–ï–ô–°–ê ---

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.style.transform = 'translateX(0)';
            setTimeout(() => toast.style.transform = 'translateX(120%)', 3000);
        }

        function updateAuthUI(user) {
            const loginView = document.getElementById('login-view');
            const userView = document.getElementById('user-view');
            
            if (user && user.displayName) {
                currentUser = user;
                loginView.classList.add('hidden');
                userView.classList.remove('hidden');
                document.getElementById('current-nickname').innerText = user.displayName;
            } else {
                currentUser = null;
                loginView.classList.remove('hidden');
                userView.classList.add('hidden');
            }
        }

        // --- –õ–û–ì–ò–ö–ê –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò ---

        document.getElementById('login-btn').addEventListener('click', async () => {
            const nick = document.getElementById('nickname-input').value.trim();
            if(nick.length < 3) return showToast("–ù–∏–∫ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π!");
            
            try {
                if (!auth.currentUser) {
                    await signInAnonymously(auth);
                }
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–º–µ–Ω—É –Ω–∏–∫–∞ (1 –º–µ—Å—è—Ü)
                const uid = auth.currentUser.uid;
                const userRef = doc(db, PATH_USERS, uid);
                const userSnap = await getDoc(userRef);
                const now = Date.now();

                if (userSnap.exists()) {
                    const lastChange = userSnap.data().lastChange || 0;
                    if (now - lastChange < 2592000000) { // 30 –¥–Ω–µ–π –≤ –º—Å
                        showToast("–ú–µ–Ω—è—Ç—å –Ω–∏–∫ –º–æ–∂–Ω–æ —Ä–∞–∑ –≤ –º–µ—Å—è—Ü!");
                        // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –∏–º—è, –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                        if(auth.currentUser.displayName) {
                            updateAuthUI(auth.currentUser);
                            return; 
                        }
                    }
                }

                await updateProfile(auth.currentUser, { displayName: nick });
                await setDoc(userRef, { nickname: nick, lastChange: now }, { merge: true });
                updateAuthUI(auth.currentUser);
                showToast("–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, " + nick);

            } catch (e) {
                console.error(e);
                showToast("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: " + e.message);
            }
        });

document.getElementById('logout-btn').addEventListener('click', () => {
             // –ü—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞ —Å–Ω–æ–≤–∞ –¥–ª—è —Å–º–µ–Ω—ã (—Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –≤–Ω—É—Ç—Ä–∏ –ª–æ–≥–∏–Ω–∞)
             document.getElementById('user-view').classList.add('hidden');
             document.getElementById('login-view').classList.remove('hidden');
        });

        // –°–ª—É—à–∞—Ç–µ–ª—å —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤—Ö–æ–¥–∞
        onAuthStateChanged(auth, (user) => {
            if (user && user.displayName) {
                updateAuthUI(user);
            }
        });

        // --- –ß–ê–¢ ---

        const chatContainer = document.getElementById('chat-container');
        const qChat = query(collection(db, PATH_CHAT), orderBy('createdAt', 'desc'), limit(50));

        onSnapshot(qChat, (snapshot) => {
            chatContainer.innerHTML = '';
            const msgs = [];
            snapshot.forEach(d => msgs.push(d.data()));
            msgs.reverse(); // –ß—Ç–æ–±—ã —Å—Ç–∞—Ä—ã–µ –±—ã–ª–∏ —Å–≤–µ—Ä—Ö—É

            msgs.forEach(msg => {
                const div = document.createElement('div');
                div.className = "bg-[#161b22] p-2 rounded border border-[#30363d] max-w-[80%]";
                div.innerHTML = <span class="text-blue-400 font-bold text-xs">${msg.author}</span>: <span class="text-gray-300">${msg.text}</span>;
                chatContainer.appendChild(div);
            });
            chatContainer.scrollTop = chatContainer.scrollHeight;
        });

        document.getElementById('send-msg-btn').addEventListener('click', async () => {
            if (!currentUser) return showToast("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ!");
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;

            try {
                await addDoc(collection(db, PATH_CHAT), {
                    text: text,
                    author: currentUser.displayName,
                    uid: currentUser.uid,
                    createdAt: serverTimestamp()
                });
                input.value = '';
            } catch (e) {
                showToast("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏");
            }
        });

        // --- –ê–ù–ö–ï–¢–´ ---

        const profilesContainer = document.getElementById('profiles-container');
        const qProfiles = query(collection(db, PATH_PROFILES), orderBy('createdAt', 'desc'), limit(20));

        onSnapshot(qProfiles, (snapshot) => {
            profilesContainer.innerHTML = '';
            if (snapshot.empty) {
                profilesContainer.innerHTML = '<div class="text-gray-500">–ê–Ω–∫–µ—Ç –ø–æ–∫–∞ –Ω–µ—Ç.</div>';
                return;
            }
            snapshot.forEach(doc => {
                const data = doc.data();
                const card = document.createElement('div');
                card.className = "bg-[#161b22] p-4 rounded-xl border border-[#30363d] hover:border-blue-500 transition";
                card.innerHTML = 
                    <div class="font-bold text-orange-400 text-lg">${data.title}</div>
                    <div class="text-sm text-blue-300 mb-2">${data.role}</div>
                    <div class="text-gray-300 text-sm mb-3 whitespace-pre-wrap">${data.desc}</div>
                    <div class="text-xs text-gray-500 border-t border-[#30363d] pt-2 flex justify-between">
                        <span>–ê–≤—Ç–æ—Ä: ${data.author}</span>
                        <span class="text-white bg-blue-900 px-2 rounded">${data.contact}</span>
                    </div>
                ;
                profilesContainer.appendChild(card);
            });
        });

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –∞–Ω–∫–µ—Ç—ã
        document.getElementById('create-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return showToast("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ!");

            const title = document.getElementById('f-title').value;
            const role = document.getElementById('f-role').value;
            const desc = document.getElementById('f-desc').value;
            const contact = document.getElementById('f-contact').value;

try {
                await addDoc(collection(db, PATH_PROFILES), {
                    title, role, desc, contact,
                    author: currentUser.displayName,
                    uid: currentUser.uid,
                    createdAt: serverTimestamp()
                });
                showToast("–ê–Ω–∫–µ—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞!");
                e.target.reset();
                app.setView('profiles');
            } catch (err) {
                showToast("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è: " + err.message);
            }
        });

        // –°—Ç–∞—Ä—Ç: –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ—Ç–∫—Ä—ã–≤–∞–µ–º –∞–Ω–∫–µ—Ç—ã
        app.setView('profiles');
    </script>
</body>
</html>
