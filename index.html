<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkMeetCraft - –ü–æ–∏—Å–∫ –∫–æ–º–∞–Ω–¥—ã</title>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: sans-serif;
            background-color: #0d1117; /* –ß–µ—Ä–Ω—ã–π —Ñ–æ–Ω */
            color: #e6edf3;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }
        /* –°–∫—Ä–æ–ª–ª–±–∞—Ä—ã */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #161b22; }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 4px; }
        
        /* –ö–ª–∞—Å—Å –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
        .nav-btn.active {
            background-color: #1f242d; /* –¢–µ–º–Ω–æ-—Å–µ—Ä—ã–π —Ñ–æ–Ω */
            color: #ffffff;
            border-color: #3b82f6; /* –°–∏–Ω—è—è —Ä–∞–º–∫–∞ */
        }
    </style>
</head>
<body class="flex flex-col md:flex-row h-full">

    <!-- –ë–õ–û–ö –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –ö–†–ò–¢–ò–ß–ï–°–ö–ò–• –û–®–ò–ë–û–ö -->
    <div id="error-display" class="hidden fixed top-0 left-0 w-full bg-red-600 text-white p-4 z-[9999] font-bold text-center"></div>

    <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
    <aside class="w-full md:w-64 bg-[#161b22] border-r border-[#30363d] flex flex-col p-4 z-20">
        <h1 class="text-2xl font-bold text-orange-500 mb-6 tracking-wider">LinkMeetCraft</h1>

        <!-- –ü–∞–Ω–µ–ª—å –≤—Ö–æ–¥–∞ -->
        <div id="auth-box" class="bg-[#0d1117] p-4 rounded-xl border border-[#30363d] mb-4 shadow-lg">
            <!-- –ï—Å–ª–∏ –Ω–µ –≤–æ—à–µ–ª -->
            <div id="login-view">
                <input type="text" id="nickname-input" placeholder="–í–∞—à –Ω–∏–∫–Ω–µ–π–º" class="w-full bg-[#21262d] border border-[#30363d] rounded p-2 text-white mb-2 focus:border-blue-500 outline-none">
                <button data-action="login" id="login-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded transition">–í–æ–π—Ç–∏</button>
            </div>
            <!-- –ï—Å–ª–∏ –≤–æ—à–µ–ª -->
            <div id="user-view" class="hidden">
                <div class="text-gray-400 text-xs">–í—ã –≤–æ—à–ª–∏ –∫–∞–∫:</div>
                <div id="current-nickname" class="text-blue-400 font-bold text-lg truncate"></div>
                <button data-action="logout" id="logout-btn" class="mt-2 text-xs text-red-400 hover:text-red-300 underline">–°–º–µ–Ω–∏—Ç—å –Ω–∏–∫</button>
            </div>
        </div>

        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
        <nav id="main-nav" class="flex-1 space-y-2">
            <button data-view="profiles" class="nav-btn active w-full text-left p-3 rounded hover:bg-[#21262d] text-gray-300 hover:text-white transition flex items-center border border-transparent focus:border-blue-500">
                üìÑ –ê–Ω–∫–µ—Ç—ã
            </button>
            <button data-view="chat" class="nav-btn w-full text-left p-3 rounded hover:bg-[#21262d] text-gray-300 hover:text-white transition flex items-center border border-transparent focus:border-blue-500">
                üí¨ –û–±—â–∏–π —á–∞—Ç
            </button>
            <button data-view="create" class="nav-btn w-full text-left p-3 rounded bg-orange-900/20 text-orange-400 hover:bg-orange-900/40 hover:text-orange-300 transition flex items-center border border-orange-900/50 mt-4">
                ‚ûï –°–æ–∑–¥–∞—Ç—å –∞–Ω–∫–µ—Ç—É
            </button>
        </nav>
    </aside>

    <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å (–ö–æ–Ω—Ç–µ–Ω—Ç) -->
    <main class="flex-1 relative bg-[#0d1117] overflow-hidden flex flex-col">
        
        <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
        <div id="toast" class="absolute top-4 right-4 bg-blue-600 text-white px-6 py-3 rounded shadow-xl transform translate-x-full transition-transform duration-300 z-50"></div>

        <!-- –≠–∫—Ä–∞–Ω: –ê–Ω–∫–µ—Ç—ã -->
        <div id="view-profiles" class="view-section h-full overflow-y-auto p-6">
            <h2 class="text-2xl font-bold text-white mb-4 border-b border-[#30363d] pb-2">–ê–∫—Ç–∏–≤–Ω—ã–µ –∞–Ω–∫–µ—Ç—ã</h2>
            <div id="profiles-container" class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div class="text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∫–µ—Ç...</div>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω: –ß–∞—Ç -->
        <div id="view-chat" class="view-section h-full flex flex-col p-4 hidden">
            <h2 class="text-xl font-bold text-white mb-2 border-b border-[#30363d] pb-2">–û–±—â–∏–π —á–∞—Ç</h2>
            <div id="chat-container" class="flex-1 overflow-y-auto space-y-3 mb-4 pr-2">
                <div class="text-center text-gray-600 mt-10">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>
            </div>
            <div class="flex gap-2">
                <input type="text" id="chat-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." class="flex-1 bg-[#21262d] border border-[#30363d] rounded p-3 text-white focus:border-blue-500 outline-none">
                <button data-action="send-msg" id="send-msg-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 rounded font-bold">></button>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω: –°–æ–∑–¥–∞–Ω–∏–µ –∞–Ω–∫–µ—Ç—ã -->
        <div id="view-create" class="view-section h-full overflow-y-auto p-6 hidden">
            <h2 class="text-2xl font-bold text-orange-500 mb-6">–ù–æ–≤–∞—è –∞–Ω–∫–µ—Ç–∞</h2>
            <form data-action="create-profile" id="create-form" class="max-w-2xl bg-[#161b22] p-6 rounded-xl border border-[#30363d] space-y-4">
                <div>
                    <label class="block text-gray-400 text-sm mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ / –¶–µ–ª—å</label>
                    <input type="text" id="f-title" required class="w-full bg-[#0d1117] border border-[#30363d] rounded p-2 text-white focus:border-orange-500 outline-none">
                </div>
                <div>
                    <label class="block text-gray-400 text-sm mb-1">–ö–æ–≥–æ –∏—â–µ—Ç–µ (–†–æ–ª—å)</label>
                    <input type="text" id="f-role" required class="w-full bg-[#0d1117] border border-[#30363d] rounded p-2 text-white focus:border-orange-500 outline-none">
                </div>
                <div>
                    <label class="block text-gray-400 text-sm mb-1">–û–ø–∏—Å–∞–Ω–∏–µ / –°—Ç–µ–∫</label>
                    <textarea id="f-desc" required rows="4" class="w-full bg-[#0d1117] border border-[#30363d] rounded p-2 text-white focus:border-orange-500 outline-none"></textarea>
                </div>
                <div>
                    <label class="block text-gray-400 text-sm mb-1">–í–∞—à –∫–æ–Ω—Ç–∞–∫—Ç (Telegram/Discord)</label>
                    <input type="text" id="f-contact" required class="w-full bg-[#0d1117] border border-[#30363d] rounded p-2 text-white focus:border-orange-500 outline-none">
                </div>
                <button type="submit" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 rounded mt-4 transition">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
            </form>
        </div>

    </main>

    <!-- –õ–û–í–ï–¶ –û–®–ò–ë–û–ö –°–ö–†–ò–ü–¢–ê –ò –ì–õ–û–ë–ê–õ–¨–ù–ê–Ø –ù–ê–í–ò–ì–ê–¶–ò–Ø -->
    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–∞, –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–æ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥—É–ª—è
        window.app = {
            setView: (viewId) => {
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                const activeView = document.getElementById('view-' + viewId);
                if (activeView) activeView.classList.remove('hidden');

                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                const selectedBtn = document.querySelector(`.nav-btn[data-view="${viewId}"]`);
                if (selectedBtn) selectedBtn.classList.add('active');

                // –ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª —á–∞—Ç–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
                if(viewId === 'chat') {
                    const container = document.getElementById('chat-container');
                    setTimeout(() => container.scrollTop = container.scrollHeight, 100);
                }
            }
        };

        // –õ–æ–≤–µ—Ü –æ—à–∏–±–æ–∫, —á—Ç–æ–±—ã –≤—ã –≤–∏–¥–µ–ª–∏, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫
        window.addEventListener('error', function(e) {
            const display = document.getElementById('error-display');
            display.innerText = "–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: " + e.message + " (—Å–º. –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π)";
            display.classList.remove('hidden');
        });
    </script>

    <!-- –°–ö–†–ò–ü–¢ –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø (–ú–æ–¥—É–ª—å) -->
    <script type="module">
        // –ò–ú–ü–û–†–¢–´ FIREBASE
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, updateProfile, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // **–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ë–õ–û–ö: –ë–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏**
        let firebaseConfig = {};
        try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –≥–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –∏ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ–Ω–∞ –Ω–µ–ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π, –ø—Ä–µ–∂–¥–µ —á–µ–º –ø–∞—Ä—Å–∏—Ç—å
            if (typeof __firebase_config === 'string' && __firebase_config.length > 0) {
                firebaseConfig = JSON.parse(__firebase_config);
            }
        } catch (e) {
            console.error("Failed to parse __firebase_config, using empty config.", e);
            document.getElementById('error-display').innerText = "–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Firebase. –í–æ–∑–º–æ–∂–Ω–æ, –ø—Ä–æ–±–ª–µ–º–∞ –≤ –æ–∫—Ä—É–∂–µ–Ω–∏–∏.";
            document.getElementById('error-display').classList.remove('hidden');
            // –ï—Å–ª–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –º—ã –Ω–µ –º–æ–∂–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å Firebase.
            // –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å, –Ω–æ –º—ã –∏–∑–±–µ–∂–∏–º –æ—à–∏–±–∫–∏ (auth/invalid-api-key)
            // –Ω–∞ —ç—Ç–∞–ø–µ initializeApp, –µ—Å–ª–∏ –∫–ª—é—á–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω–µ—Ç.
            // –û–¥–Ω–∞–∫–æ, –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã, –º—ã –≤—Å–µ —Ä–∞–≤–Ω–æ –¥–æ–ª–∂–Ω—ã –≤—ã–∑–≤–∞—Ç—å initializeApp
        }
        
        // --- –ü–£–¢–ò –ö FIRESTORE ---
        const PATH_PROFILES = `/artifacts/${appId}/public/data/profiles`;
        const PATH_CHAT = `/artifacts/${appId}/public/data/chat`;
        const PATH_USERS = `/artifacts/${appId}/users`;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        const firebaseApp = initializeApp(firebaseConfig);
        const auth = getAuth(firebaseApp);
        const db = getFirestore(firebaseApp);

        let currentUser = null;

        // --- –§–£–ù–ö–¶–ò–ò –ò–ù–¢–ï–†–§–ï–ô–°–ê ---

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.style.transform = 'translateX(0)';
            setTimeout(() => toast.style.transform = 'translateX(120%)', 3000);
        }

        function updateAuthUI(user) {
            const loginView = document.getElementById('login-view');
            const userView = document.getElementById('user-view');
            
            if (user && user.displayName) {
                currentUser = user;
                loginView.classList.add('hidden');
                userView.classList.remove('hidden');
                document.getElementById('current-nickname').innerText = user.displayName;
            } else {
                currentUser = null;
                loginView.classList.remove('hidden');
                userView.classList.add('hidden');
            }
        }
        
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
        function copyToClipboard(text, message) {
            const tempInput = document.createElement('input');
            tempInput.value = text;
            document.body.appendChild(tempInput);
            tempInput.select();
            try {
                document.execCommand('copy');
                showToast(message || "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!");
            } catch (err) {
                showToast("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å.");
                console.error('Copy failed:', err);
            }
            document.body.removeChild(tempInput);
        }

        // --- –õ–û–ì–ò–ö–ê –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò ---

        async function handleLogin() {
            const nick = document.getElementById('nickname-input').value.trim();
            if(nick.length < 3) return showToast("–ù–∏–∫ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π!");
            
            try {
                // –ï—Å–ª–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω (–∏–ª–∏ –∞–Ω–æ–Ω–∏–º), –∞–≤—Ç–æ—Ä–∏–∑—É–µ–º—Å—è
                if (!auth.currentUser) {
                    await signInAnonymously(auth);
                }
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–º–µ–Ω—É –Ω–∏–∫–∞ (1 –º–µ—Å—è—Ü)
                const uid = auth.currentUser.uid;
                const userRef = doc(db, PATH_USERS, uid);
                const userSnap = await getDoc(userRef);
                const now = Date.now();

                let canChange = true;
                if (userSnap.exists()) {
                    const lastChange = userSnap.data().lastChange || 0;
                    // 2592000000 –º—Å = 30 –¥–Ω–µ–π
                    if (now - lastChange < 2592000000) { 
                        const daysLeft = Math.ceil((2592000000 - (now - lastChange)) / (1000 * 60 * 60 * 24));
                        canChange = false;
                        
                        if (!canChange) {
                            showToast(`–ú–µ–Ω—è—Ç—å –Ω–∏–∫ –º–æ–∂–Ω–æ —Ä–∞–∑ –≤ –º–µ—Å—è—Ü! –û—Å—Ç–∞–ª–æ—Å—å: ${daysLeft} –¥–Ω–µ–π.`);
                        }
                    }
                }
                
                // –°–º–µ–Ω–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∞ –∏–ª–∏ –Ω–∏–∫ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤–ø–µ—Ä–≤—ã–µ
                if (canChange) {
                    await updateProfile(auth.currentUser, { displayName: nick });
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∏–∫ –∏ –≤—Ä–µ–º—è —Å–º–µ–Ω—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
                    await setDoc(userRef, { nickname: nick, lastChange: now, uid: uid }, { merge: true });
                }
                
                updateAuthUI(auth.currentUser);
                showToast("–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, " + auth.currentUser.displayName);
                
                // –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—Ö–æ–¥–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏ Firestore
                setupFirestoreListeners();

            } catch (e) {
                console.error("Login error:", e);
                showToast("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: " + e.message);
            }
        }

        function handleLogout() {
             // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞ —Å–Ω–æ–≤–∞ –¥–ª—è —Å–º–µ–Ω—ã –Ω–∏–∫–∞
             document.getElementById('user-view').classList.add('hidden');
             document.getElementById('login-view').classList.remove('hidden');
             document.getElementById('nickname-input').value = currentUser ? currentUser.displayName : '';
        }
        
        // –°–ª—É—à–∞—Ç–µ–ª—å —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤—Ö–æ–¥–∞
        onAuthStateChanged(auth, (user) => {
            if (user && user.uid) {
                if (user.displayName) {
                    updateAuthUI(user);
                    setupFirestoreListeners();
                } else {
                    updateAuthUI(null); 
                }
            } else {
                 updateAuthUI(null);
            }
        });

        // --- –ß–ê–¢ ---

        async function sendMessage() {
            if (!currentUser || !currentUser.displayName) return showToast("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ (—É–∫–∞–∂–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º)!");
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;

            try {
                input.value = ''; // –û—á–∏—Å—Ç–∫–∞ —Å—Ä–∞–∑—É
                await addDoc(collection(db, PATH_CHAT), {
                    text: text,
                    author: currentUser.displayName,
                    uid: currentUser.uid,
                    createdAt: serverTimestamp()
                });
            } catch (e) {
                showToast("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è.");
                input.value = text; // –í–æ–∑–≤—Ä–∞—Ç —Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ
            }
        }

        function setupChatListener() {
            const chatContainer = document.getElementById('chat-container');
            const qChat = query(collection(db, PATH_CHAT), orderBy('createdAt', 'desc'), limit(50));

            const unsubscribeChat = onSnapshot(qChat, (snapshot) => {
                chatContainer.innerHTML = '';
                const msgs = [];
                snapshot.forEach(d => msgs.push(d.data()));
                msgs.reverse(); // –ß—Ç–æ–±—ã —Å—Ç–∞—Ä—ã–µ –±—ã–ª–∏ —Å–≤–µ—Ä—Ö—É

                msgs.forEach(msg => {
                    const div = document.createElement('div');
                    div.className = "bg-[#1f242d] p-2 rounded max-w-[80%]";
                    div.innerHTML = `<span class="text-blue-400 font-bold text-xs">${msg.author}</span>: <span class="text-gray-300">${msg.text}</span>`;
                    chatContainer.appendChild(div);
                });
                
                if (!document.getElementById('view-chat').classList.contains('hidden')) {
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
            }, (error) => {
                 console.error("Chat listener error:", error);
                 showToast("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–∞.");
            });
            return unsubscribeChat;
        }

        // --- –ê–ù–ö–ï–¢–´ ---

        async function createProfile(e) {
            e.preventDefault();
            if (!currentUser || !currentUser.displayName) return showToast("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ (—É–∫–∞–∂–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º)!");

            const title = document.getElementById('f-title').value.trim();
            const role = document.getElementById('f-role').value.trim();
            const desc = document.getElementById('f-desc').value.trim();
            const contact = document.getElementById('f-contact').value.trim();

            if (!title || !role || !desc || !contact) {
                return showToast("–í—Å–µ –ø–æ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã!");
            }

            try {
                await addDoc(collection(db, PATH_PROFILES), {
                    title, role, desc, contact,
                    author: currentUser.displayName,
                    uid: currentUser.uid,
                    createdAt: serverTimestamp()
                });
                showToast("–ê–Ω–∫–µ—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞!");
                e.target.reset();
                window.app.setView('profiles');
            } catch (err) {
                console.error("Create profile error:", err);
                showToast("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞–Ω–∫–µ—Ç—ã.");
            }
        }

        function setupProfilesListener() {
            const profilesContainer = document.getElementById('profiles-container');
            const qProfiles = query(collection(db, PATH_PROFILES), orderBy('createdAt', 'desc'), limit(20));

            const unsubscribeProfiles = onSnapshot(qProfiles, (snapshot) => {
                profilesContainer.innerHTML = '';
                if (snapshot.empty) {
                    profilesContainer.innerHTML = '<div class="text-gray-500 col-span-full text-center p-4">–ê–Ω–∫–µ—Ç –ø–æ–∫–∞ –Ω–µ—Ç. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</div>';
                    return;
                }
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const card = document.createElement('div');
                    card.className = "bg-[#1f242d] p-4 rounded-xl border border-[#30363d] hover:border-blue-500 transition shadow-lg";
                    
                    const profileId = doc.id; 
                    const profileURL = `${window.location.origin}${window.location.pathname}?profileId=${profileId}`; 

                    card.innerHTML = `
                        <div class="font-bold text-orange-400 text-lg">${data.title}</div>
                        <div class="text-sm text-blue-300 mb-2">–ò—â–µ—Ç: ${data.role}</div>
                        <p class="text-gray-300 text-sm mb-3 whitespace-pre-wrap line-clamp-3">${data.desc}</p>
                        <div class="text-xs text-gray-500 border-t border-[#30363d] pt-2 flex flex-col sm:flex-row sm:justify-between sm:items-center mt-2 gap-2">
                            <span class="font-medium text-gray-400">–ê–≤—Ç–æ—Ä: ${data.author}</span>
                            <div class="flex flex-col sm:flex-row gap-2">
                                <button data-url="${profileURL}" class="copy-link-btn text-xs text-white bg-green-600 hover:bg-green-700 px-3 py-1 rounded-full transition">
                                    üîó –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É
                                </button>
                                <span class="text-sm text-white bg-blue-700 px-3 py-1 rounded-full">${data.contact}</span>
                            </div>
                        </div>
                    `;
                    
                    card.querySelector('.copy-link-btn').addEventListener('click', (e) => {
                        e.stopPropagation(); 
                        const url = e.currentTarget.getAttribute('data-url');
                        copyToClipboard(url, "–°—Å—ã–ª–∫–∞ –Ω–∞ –∞–Ω–∫–µ—Ç—É —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!");
                    });
                    
                    profilesContainer.appendChild(card);
                });
            }, (error) => {
                 console.error("Profiles listener error:", error);
                 showToast("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∫–µ—Ç.");
            });
            return unsubscribeProfiles;
        }
        
        // –•—Ä–∞–Ω–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π –æ—Ç–ø–∏—Å–∫–∏ –æ—Ç —Å–ª—É—à–∞—Ç–µ–ª–µ–π
        let unsubscribeListeners = [];

        function setupFirestoreListeners() {
            // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç —Å—Ç–∞—Ä—ã—Ö —Å–ª—É—à–∞—Ç–µ–ª–µ–π –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤—ã—Ö
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];
            
            if (currentUser && currentUser.displayName) {
                 unsubscribeListeners.push(setupChatListener());
                 unsubscribeListeners.push(setupProfilesListener());
            }
        }

        // --- –ó–ê–ü–£–°–ö ---
        
        // –ó–∞–ø—É—Å–∫ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö —Å–ª—É—à–∞—Ç–µ–ª–µ–π (–∫–Ω–æ–ø–∫–∏, —Ñ–æ—Ä–º—ã)
        document.addEventListener('DOMContentLoaded', () => {
             // –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    window.app.setView(btn.dataset.view);
                });
            });

            // –ö–Ω–æ–ø–∫–∞ –í—Ö–æ–¥
            document.getElementById('login-btn').addEventListener('click', handleLogin);
            
            // –ö–Ω–æ–ø–∫–∞ –°–º–µ–Ω–∏—Ç—å –Ω–∏–∫
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            
            // –ö–Ω–æ–ø–∫–∞ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
            document.getElementById('send-msg-btn').addEventListener('click', sendMessage);
            document.getElementById('chat-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });

            // –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞–Ω–∫–µ—Ç—ã
            document.getElementById('create-form').addEventListener('submit', createProfile);
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ
            window.app.setView('profiles');
        });
    </script>
</body>
</html>
