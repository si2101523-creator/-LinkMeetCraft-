<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkMeetCraft - –ü–æ–∏—Å–∫ –∫–æ–º–∞–Ω–¥—ã –∏ —á–∞—Ç</title>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —à—Ä–∏—Ñ—Ç–∞ Inter –∏ –æ–±—â–µ–≥–æ —á—ë—Ä–Ω–æ–≥–æ —Ñ–æ–Ω–∞ */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* –¢—ë–º–Ω—ã–π, –ø–æ—á—Ç–∏ —á—ë—Ä–Ω—ã–π —Ñ–æ–Ω */
            color: #e6edf3; /* –°–≤–µ—Ç–ª—ã–π —Ç–µ–∫—Å—Ç */
            min-height: 100vh;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–∫—Ä–æ–ª–ª–±–∞—Ä–æ–≤, —á—Ç–æ–±—ã –æ–Ω–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞–ª–∏ —Ç—ë–º–Ω–æ–π —Ç–µ–º–µ */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #384252; /* –ë–æ–ª–µ–µ —Ç—ë–º–Ω—ã–π –ø–æ–ª–∑—É–Ω–æ–∫ */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background-color: #1a1f26; /* –û—á–µ–Ω—å —Ç—ë–º–Ω—ã–π —Ç—Ä–µ–∫ */
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top: 4px solid #3b82f6; /* –°–∏–Ω–∏–π —Ü–≤–µ—Ç */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* –°—Ç–∏–ª—å –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –≤–æ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏, –Ω–æ –Ω–µ –≤—Å–µ–≥–æ UI */
        .content-disabled {
            opacity: 0.5;
            pointer-events: none;
        }
    </style>
</head>
<body class="p-4 sm:p-6">

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
    <div id="app" class="flex flex-col md:flex-row h-[calc(100vh-3rem)] rounded-xl shadow-2xl overflow-hidden bg-[#161b22]">
        
        <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏/–ø—Ä–æ—Ñ–∏–ª—è (–°–∏–Ω–∏–π/–û—Ä–∞–Ω–∂–µ–≤—ã–π –∞–∫—Ü–µ–Ω—Ç) -->
        <aside class="w-full md:w-64 p-4 flex flex-col space-y-4 bg-[#1f242d] border-r border-gray-700">
            
            <h1 class="text-2xl font-bold text-orange-400 mb-4">LinkMeetCraft</h1>

            <!-- –ë–ª–æ–∫ –ø—Ä–æ—Ñ–∏–ª—è –∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ -->
            <div id="auth-panel" class="bg-gray-800 p-3 rounded-lg shadow-inner">
                <div id="user-info" class="hidden">
                    <p class="text-sm text-gray-400">–ü—Ä–∏–≤–µ—Ç, <span id="display-nickname" class="text-blue-400 font-semibold"></span>!</p>
                    <p class="text-xs text-gray-500 mt-1">ID: <span id="display-user-id" class="text-gray-400 text-xs"></span></p>
                    <button id="change-nickname-btn" class="mt-2 w-full py-1 text-xs bg-orange-500 hover:bg-orange-600 rounded-md transition duration-150">–°–º–µ–Ω–∏—Ç—å –Ω–∏–∫</button>
                </div>
                <div id="login-form-container">
                    <input type="text" id="login-nickname" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –Ω–∏–∫–Ω–µ–π–º" class="w-full p-2 text-sm bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500 text-white placeholder-gray-400">
                    <button id="login-btn" class="mt-2 w-full py-2 text-sm bg-blue-500 hover:bg-blue-600 rounded-md transition duration-150 font-semibold">–í–æ–π—Ç–∏</button>
                </div>
            </div>

            <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
            <nav id="nav-menu" class="flex flex-col space-y-2 flex-grow">
                <!-- –ö–ª–∞—Å—Å bg-blue-600 –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∏ –≤—ã–≥–ª—è–¥–µ–ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–º–∏ -->
                <button data-view="profiles" class="nav-btn bg-blue-600 hover:bg-blue-700 p-3 rounded-lg text-lg font-semibold transition duration-150 shadow-md">
                    <span class="mr-2">üìù</span> –ê–Ω–∫–µ—Ç—ã
                </button>
                <button data-view="chat" class="nav-btn bg-gray-700 hover:bg-gray-600 p-3 rounded-lg text-lg font-semibold transition duration-150">

<span class="mr-2">üí¨</span> –û–±—â–∏–π —á–∞—Ç
                </button>
                <button data-view="new-profile" class="nav-btn bg-orange-500 hover:bg-orange-600 p-3 rounded-lg text-lg font-semibold transition duration-150">
                    <span class="mr-2">‚ú®</span> –°–æ–∑–¥–∞—Ç—å –∞–Ω–∫–µ—Ç—É
                </button>
            </nav>

        </aside>

        <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å –∫–æ–Ω—Ç–µ–Ω—Ç–∞ -->
        <main id="main-content-area" class="flex-grow p-4 md:p-6 overflow-y-auto custom-scrollbar">

            <!-- –û–±–ª–∞—Å—Ç—å –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π -->
            <div id="message-area" class="mb-4 hidden p-3 rounded-lg text-center font-medium transition duration-300"></div>
            
            <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
            <div id="loading-indicator" class="absolute top-0 left-0 w-full h-full bg-[#161b22]/70 flex justify-center items-center z-50 hidden">
                <div class="flex items-center">
                    <div class="spinner"></div>
                    <p class="ml-3 text-gray-200 font-semibold">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
                </div>
            </div>

            <!-- 1. –°–ø–∏—Å–æ–∫ –∞–Ω–∫–µ—Ç (Profiles View) -->
            <section id="profiles-view" class="view-content">
                <h2 class="text-3xl font-bold mb-6 text-blue-400">–í—Å–µ –∞–Ω–∫–µ—Ç—ã</h2>
                <div id="profiles-list" class="grid gap-6 grid-cols-1 lg:grid-cols-2">
                    <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ –∞–Ω–∫–µ—Ç -->
                    <p class="text-gray-500 text-center col-span-full" id="no-profiles-message">–ê–Ω–∫–µ—Ç –ø–æ–∫–∞ –Ω–µ—Ç. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</p>
                </div>
            </section>

            <!-- 2. –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞–Ω–∫–µ—Ç—ã (New Profile View) -->
            <section id="new-profile-view" class="view-content hidden">
                <h2 class="text-3xl font-bold mb-6 text-orange-400">–°–æ–∑–¥–∞—Ç—å –∞–Ω–∫–µ—Ç—É</h2>
                <form id="profile-form" class="space-y-4 bg-[#1f242d] p-6 rounded-xl shadow-lg border border-gray-700">
                    
                    <label class="block">
                        <span class="text-gray-300">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ / –í–∞—à–∞ —Ü–µ–ª—å (–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span>
                        <input type="text" id="profile-title" required class="mt-1 block w-full p-3 bg-gray-700 border border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </label>

                    <label class="block">
                        <span class="text-gray-300">–†–æ–ª—å, –∫–æ—Ç–æ—Ä—É—é –≤—ã –∏—â–µ—Ç–µ / –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç–µ (–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span>
                        <input type="text" id="profile-role" required class="mt-1 block w-full p-3 bg-gray-700 border border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </label>

                    <label class="block">
                        <span class="text-gray-300">–í–∞—à –æ–ø—ã—Ç / –°—Ç–µ–∫ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π</span>
                        <textarea id="profile-experience" rows="3" class="mt-1 block w-full p-3 bg-gray-700 border border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </label>
                    
                    <label class="block">
                        <span class="text-gray-300">–ö–æ–Ω—Ç–∞–∫—Ç –¥–ª—è —Å–≤—è–∑–∏ (Telegram, Discord –∏ —Ç.–¥.) (–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span>
                        <input type="text" id="profile-contact" required class="mt-1 block w-full p-3 bg-gray-700 border border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </label>

                    <label class="block">
                        <span class="text-gray-300">–ü–æ–¥—Ä–æ–±–Ω–µ–µ –æ –ø—Ä–æ–µ–∫—Ç–µ / –û —Å–µ–±–µ</span>
                        <textarea id="profile-about" rows="5" class="mt-1 block w-full p-3 bg-gray-700 border border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </label>

<button type="submit" class="w-full py-3 bg-orange-500 hover:bg-orange-600 rounded-md text-lg font-bold transition duration-150">
                        –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –∞–Ω–∫–µ—Ç—É
                    </button>
                </form>
            </section>

            <!-- 3. –û–±—â–∏–π —á–∞—Ç (Chat View) -->
            <section id="chat-view" class="view-content hidden flex flex-col h-full">
                <h2 class="text-3xl font-bold mb-4 text-blue-400">–û–±—â–∏–π —á–∞—Ç</h2>
                <div id="chat-messages" class="flex-grow p-4 space-y-4 overflow-y-auto custom-scrollbar bg-[#1f242d] rounded-xl mb-4 h-96">
                    <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —á–∞—Ç–∞ -->
                    <p class="text-gray-500 text-center" id="no-chat-message">–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–≤—ã–º!</p>
                </div>
                <div id="chat-input-area" class="flex">
                    <input type="text" id="chat-message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." class="flex-grow p-3 bg-gray-700 border border-gray-600 rounded-l-lg focus:outline-none focus:ring-1 focus:ring-blue-500 text-white">
                    <button id="send-message-btn" class="bg-blue-500 hover:bg-blue-600 px-6 py-3 rounded-r-lg font-semibold transition duration-150">
                        –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                    </button>
                </div>
            </section>

        </main>
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, onSnapshot, collection, query, serverTimestamp, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- 1. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ö–û–ù–°–¢–ê–ù–¢–´ ---
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–∑ —Å—Ä–µ–¥—ã Canvas
        const appId = typeof app_id !== 'undefined' ? app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof firebase_config !== 'undefined' ? firebase_config : '{}');
        const initialAuthToken = typeof initial_auth_token !== 'undefined' ? initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = null;
        let nickname = null;
        let isAuthReady = false;

        // –ü—É—Ç–∏ –∫ –∫–æ–ª–ª–µ–∫—Ü–∏—è–º Firestore
        const USERS_COLLECTION = /artifacts/${appId}/users;
        const PUBLIC_PROFILES_COLLECTION = /artifacts/${appId}/public/data/profiles;
        const PUBLIC_CHAT_COLLECTION = /artifacts/${appId}/public/data/chat;
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const appContainer = document.getElementById('app');
        const messageArea = document.getElementById('message-area');
        const loadingIndicator = document.getElementById('loading-indicator');
        const loginNicknameInput = document.getElementById('login-nickname');
        const loginBtn = document.getElementById('login-btn');
        const profileForm = document.getElementById('profile-form');
        const profilesList = document.getElementById('profiles-list');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-message-input');
        const sendBtn = document.getElementById('send-message-btn');
        const navButtons = document.querySelectorAll('.nav-btn');
        const mainContentArea = document.getElementById('main-content-area'); // –ì–ª–∞–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        
        // --- 2. –£–¢–ò–õ–ò–¢–´ ---
        
        /**
         * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–ª–∏ —Å–∫—Ä—ã–≤–∞–µ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –±–ª–æ–∫–∏—Ä—É–µ—Ç –≥–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç.

* @param {boolean} show
         */
        function showLoading(show) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            loadingIndicator.classList.toggle('hidden', !show);
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω—É—é –æ–±–ª–∞—Å—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (Main), –Ω–æ –Ω–µ –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å (Aside), 
            // —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É –¥–∞–∂–µ –≤–æ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏.
            mainContentArea.classList.toggle('content-disabled', show);
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏, –ø–æ–∫–∞ –Ω–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            document.getElementById('nav-menu').classList.toggle('content-disabled', show && !isAuthReady);
        }

        /**
         * –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
         * @param {string} text –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è.
         * @param {string} type –¢–∏–ø: '—É—Å–ø–µ—Ö', '–æ—à–∏–±–∫–∞', '–∏–Ω—Ñ–æ'.
         */
        function showMessage(text, type = '–∏–Ω—Ñ–æ') {
            messageArea.textContent = text;
            messageArea.classList.remove('hidden', 'bg-green-700', 'bg-red-700', 'bg-blue-700');
            
            let bgColor = 'bg-blue-700';
            if (type === '—É—Å–ø–µ—Ö') bgColor = 'bg-green-700';
            if (type === '–æ—à–∏–±–∫–∞') bgColor = 'bg-red-700';

            messageArea.classList.add(bgColor);
            
            setTimeout(() => {
                messageArea.classList.add('hidden');
            }, 5000);
        }

        /**
         * –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –º–µ–∂–¥—É —Ä–∞–∑–¥–µ–ª–∞–º–∏.
         * @param {string} viewName –ò–º—è —Ä–∞–∑–¥–µ–ª–∞ ('profiles', 'chat', 'new-profile').
         */
        function switchView(viewName) {
            document.querySelectorAll('.view-content').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(${viewName}-view).classList.remove('hidden');

            document.querySelectorAll('.nav-btn').forEach(btn => {
                const isSelected = btn.dataset.view === viewName;
                btn.classList.toggle('bg-blue-600', isSelected);
                btn.classList.toggle('hover:bg-blue-700', isSelected);
                btn.classList.toggle('bg-gray-700', !isSelected);
                btn.classList.toggle('hover:bg-gray-600', !isSelected);
            });
            
            // –ï—Å–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –≤ —á–∞—Ç, –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
            if (viewName === 'chat') {
                setTimeout(() => chatMessages.scrollTop = chatMessages.scrollHeight, 100);
            }
        }

        /**
         * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—É—é –º–µ—Ç–∫—É
         * @param {number} timestamp
         * @returns {string}
         */
        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp.seconds * 1000);
            return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
        }


        // --- 3. –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø –ò –£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ú ---

        /**
         * –ó–∞–≤–µ—Ä—à–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –Ω–∏–∫–Ω–µ–π–º.
         * @param {string} newNickname –ù–∏–∫–Ω–µ–π–º, –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.
         */
        async function completeLogin(newNickname) {
            if (!newNickname || newNickname.length < 3) {
                showMessage("–ù–∏–∫–Ω–µ–π–º –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –Ω–µ –º–µ–Ω–µ–µ 3 —Å–∏–º–≤–æ–ª–æ–≤.", "–æ—à–∏–±–∫–∞");
                return;
            }
            showLoading(true);
            
            try {
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è Firebase Auth
                await updateProfile(auth.currentUser, { displayName: newNickname });

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–æ–∫—É–º–µ–Ω—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Firestore
                const userDocRef = doc(db, USERS_COLLECTION, auth.currentUser.uid);
                const userDocSnap = await getDoc(userDocRef);
                
                const now = Date.now();
                const userPublicData = {
                    nickname: newNickname,
                    lastNicknameChange: now,
                    createdAt: now
                };

if (userDocSnap.exists()) {
                    // –ï—Å–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º –Ω–∏–∫–Ω–µ–π–º
                    await updateDoc(userDocRef, { 
                        nickname: newNickname, 
                        lastNicknameChange: now 
                    });
                } else {
                    // –ï—Å–ª–∏ –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, —Å–æ–∑–¥–∞–µ–º –¥–æ–∫—É–º–µ–Ω—Ç
                    await setDoc(userDocRef, userPublicData);
                }

                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ UI
                nickname = newNickname;
                updateUserInfoUI(auth.currentUser);
                showMessage(–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${nickname}!, "—É—Å–ø–µ—Ö");

            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∏–∫–Ω–µ–π–º–∞:", error);
                showMessage("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –Ω–∏–∫–Ω–µ–π–º–∞.", "–æ—à–∏–±–∫–∞");
            } finally {
                showLoading(false);
            }
        }

        /**
         * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Ö–æ–¥–∞ (–µ—Å–ª–∏ —Ç–æ–∫–µ–Ω –ø—É—Å—Ç–æ–π –∏–ª–∏ –∞–Ω–æ–Ω–∏–º–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å).
         */
        loginBtn.addEventListener('click', async () => {
            const desiredNickname = loginNicknameInput.value.trim();
            if (!desiredNickname) {
                showMessage("–í–≤–µ–¥–∏—Ç–µ –∂–µ–ª–∞–µ–º—ã–π –Ω–∏–∫–Ω–µ–π–º.", "–∏–Ω—Ñ–æ");
                return;
            }
            
            showLoading(true);
            try {
                // –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω—è–µ–º –∞–Ω–æ–Ω–∏–º–Ω—ã–π –≤—Ö–æ–¥
                if (!auth.currentUser || auth.currentUser.isAnonymous) {
                    await signInAnonymously(auth);
                }
                // –ó–∞—Ç–µ–º –∑–∞–≤–µ—Ä—à–∞–µ–º –≤—Ö–æ–¥, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—è –Ω–∏–∫–Ω–µ–π–º
                await completeLogin(desiredNickname);
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:", error);
                showMessage("–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–π—Ç–∏.", "–æ—à–∏–±–∫–∞");
            } finally {
                showLoading(false);
            }
        });

        /**
         * –û–±–Ω–æ–≤–ª—è–µ—Ç UI –ø–æ—Å–ª–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏.
         * @param {Object} user –û–±—ä–µ–∫—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Firebase.
         */
        function updateUserInfoUI(user) {
            const loginFormContainer = document.getElementById('login-form-container');
            const userInfo = document.getElementById('user-info');
            
            if (user && user.displayName) {
                nickname = user.displayName;
                userId = user.uid;
                document.getElementById('display-nickname').textContent = nickname;
                document.getElementById('display-user-id').textContent = userId;
                loginFormContainer.classList.add('hidden');
                userInfo.classList.remove('hidden');
                
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≥–æ—Ç–æ–≤
                isAuthReady = true; 
                document.getElementById('nav-menu').classList.remove('content-disabled');

            } else {
                loginFormContainer.classList.remove('hidden');
                userInfo.classList.add('hidden');
                
                // –ï—Å–ª–∏ –Ω–∏–∫–Ω–µ–π–º–∞ –Ω–µ—Ç, –±–ª–æ–∫–∏—Ä—É–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é, –∫—Ä–æ–º–µ –ª–æ–≥–∏–Ω–∞
                isAuthReady = false; 
                document.getElementById('nav-menu').classList.add('content-disabled');
            }
        }

        /**
         * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–º–µ–Ω—ã –Ω–∏–∫–Ω–µ–π–º–∞ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –Ω–∞ 1 –º–µ—Å—è—Ü.
         */
        document.getElementById('change-nickname-btn').addEventListener('click', async () => {
            if (!userId) return;

            showLoading(true);
            try {
                const userDocRef = doc(db, USERS_COLLECTION, userId);
                const userDocSnap = await getDoc(userDocRef);
                
                if (!userDocSnap.exists()) {
                    showMessage("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.", "–æ—à–∏–±–∫–∞");
                    return;
                }

                const userData = userDocSnap.data();
                const lastChange = userData.lastNicknameChange || 0;
                const thirtyDays = 30 * 24 * 60 * 60 * 1000;
                const timeSinceLastChange = Date.now() - lastChange;

if (timeSinceLastChange < thirtyDays) {
                    const remainingDays = Math.ceil((thirtyDays - timeSinceLastChange) / (1000 * 60 * 60 * 24));
                    showMessage(–ù–∏–∫–Ω–µ–π–º –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å —Ç–æ–ª—å–∫–æ —Ä–∞–∑ –≤ 30 –¥–Ω–µ–π. –û—Å—Ç–∞–ª–æ—Å—å –¥–Ω–µ–π: ${remainingDays}., "–∏–Ω—Ñ–æ");
                    return;
                }
                
                const newNickname = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –Ω–∏–∫–Ω–µ–π–º (–º–∏–Ω 3 —Å–∏–º–≤–æ–ª–∞):");
                if (newNickname && newNickname.trim().length >= 3) {
                    await completeLogin(newNickname.trim());
                } else if (newNickname !== null) {
                    showMessage("–ù–∏–∫–Ω–µ–π–º –æ—Ç–º–µ–Ω–µ–Ω –∏–ª–∏ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π.", "–∏–Ω—Ñ–æ");
                }

            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –Ω–∏–∫–Ω–µ–π–º–∞:", error);
                showMessage("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —Å–º–µ–Ω–∏—Ç—å –Ω–∏–∫–Ω–µ–π–º.", "–æ—à–∏–±–∫–∞");
            } finally {
                showLoading(false);
            }
        });


        // --- 4. –£–ü–†–ê–í–õ–ï–ù–ò–ï –ê–ù–ö–ï–¢–ê–ú–ò (PROFILES) ---

        /**
         * –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∞–Ω–∫–µ—Ç –≤ DOM.
         * @param {Array<Object>} profiles –ú–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ –∞–Ω–∫–µ—Ç.
         */
        function renderProfiles(profiles) {
            profilesList.innerHTML = '';
            
            if (profiles.length === 0) {
                document.getElementById('no-profiles-message').classList.remove('hidden');
                return;
            }
            document.getElementById('no-profiles-message').classList.add('hidden');


            profiles.forEach(profile => {
                const profileCard = document.createElement('div');
                profileCard.className = 'bg-[#1f242d] p-5 rounded-xl shadow-xl border border-blue-800/50 hover:border-blue-500 transition duration-300';
                
                profileCard.innerHTML = 
                    <h3 class="text-xl font-bold mb-2 text-orange-400">${profile.title}</h3>
                    <p class="text-blue-400 font-semibold mb-3 border-b border-gray-700 pb-2">–†–æ–ª—å: ${profile.role}</p>
                    
                    <p class="text-sm text-gray-300 mb-2">–û–ø—ã—Ç/–°—Ç–µ–∫: <span class="text-gray-400">${profile.experience || '–ù–µ —É–∫–∞–∑–∞–Ω'}</span></p>
                    <p class="text-sm text-gray-300 mb-4">–û–ø–∏—Å–∞–Ω–∏–µ: <span class="text-gray-400">${profile.about || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}</span></p>

                    <div class="pt-3 border-t border-gray-700">
                        <p class="text-xs text-gray-500">–ê–≤—Ç–æ—Ä: <span class="text-blue-300">${profile.userNickname || '–ê–Ω–æ–Ω–∏–º'}</span></p>
                        <p class="text-xs text-gray-500 mt-1">–ö–æ–Ω—Ç–∞–∫—Ç: <span class="text-orange-300 font-medium break-all">${profile.contact}</span></p>
                    </div>
                ;
                profilesList.appendChild(profileCard);
            });
        }
        
        /**
         * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã –∞–Ω–∫–µ—Ç—ã.
         */
        profileForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!nickname) {
                showMessage("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Å–≤–æ–π –Ω–∏–∫–Ω–µ–π–º.", "–∏–Ω—Ñ–æ");
                return;
            }

            const title = document.getElementById('profile-title').value.trim();
            const role = document.getElementById('profile-role').value.trim();
            const experience = document.getElementById('profile-experience').value.trim();
            const contact = document.getElementById('profile-contact').value.trim();
            const about = document.getElementById('profile-about').value.trim();

            if (!title  !role  !contact) {
                showMessage("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: –ù–∞–∑–≤–∞–Ω–∏–µ, –†–æ–ª—å –∏ –ö–æ–Ω—Ç–∞–∫—Ç.", "–æ—à–∏–±–∫–∞");
                return;
            }

            showLoading(true);

try {
                const profileData = {
                    title: title,
                    role: role,
                    experience: experience,
                    contact: contact,
                    about: about,
                    userId: userId,
                    userNickname: nickname,
                    createdAt: serverTimestamp()
                };

                await addDoc(collection(db, PUBLIC_PROFILES_COLLECTION), profileData);

                showMessage("–ê–Ω–∫–µ—Ç–∞ —É—Å–ø–µ—à–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞!", "—É—Å–ø–µ—Ö");
                profileForm.reset();
                switchView('profiles'); // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä –∞–Ω–∫–µ—Ç

            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–Ω–∫–µ—Ç—ã:", error);
                showMessage("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∞–Ω–∫–µ—Ç—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.", "–æ—à–∏–±–∫–∞");
            } finally {
                showLoading(false);
            }
        });

        // --- 5. –£–ü–†–ê–í–õ–ï–ù–ò–ï –ß–ê–¢–û–ú (CHAT) ---

        /**
         * –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —á–∞—Ç–∞ –≤ DOM.
         * @param {Object} message –°–æ–æ–±—â–µ–Ω–∏–µ Firestore.
         */
        function renderMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.className = 'flex items-start space-x-3';
            
            const timestamp = formatTimestamp(message.createdAt);
            
            messageElement.innerHTML = 
                <div>
                    <span class="text-blue-400 font-semibold">${message.userNickname || '–ê–Ω–æ–Ω–∏–º'}</span>
                    <span class="text-gray-500 text-xs ml-2">${timestamp}</span>
                    <p class="text-gray-200 break-words mt-1">${message.text}</p>
                </div>
            ;
            chatMessages.appendChild(messageElement);
        }

        /**
         * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è.
         */
        sendBtn.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        async function sendMessage() {
            const text = chatInput.value.trim();
            
            if (!nickname) {
                showMessage("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Å–≤–æ–π –Ω–∏–∫–Ω–µ–π–º, —á—Ç–æ–±—ã –ø–∏—Å–∞—Ç—å –≤ —á–∞—Ç.", "–∏–Ω—Ñ–æ");
                return;
            }
            
            if (text.length === 0) return;

            chatInput.value = ''; // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª—è –≤–≤–æ–¥–∞
            
            try {
                const messageData = {
                    userId: userId,
                    userNickname: nickname,
                    text: text,
                    createdAt: serverTimestamp()
                };

                await addDoc(collection(db, PUBLIC_CHAT_COLLECTION), messageData);

            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:", error);
                showMessage("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ.", "–æ—à–∏–±–∫–∞");
                chatInput.value = text; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—Å—Ç, –µ—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å
            }
        }

        // --- 6. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø –ò –°–õ–£–®–ê–¢–ï–õ–ò FIRESTORE ---

        /**
         * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç Firebase –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–ª—É—à–∞—Ç–µ–ª–∏.
         */
        async function initApp() {
            try {
                showLoading(true);

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // –°–ª—É—à–∞—Ç–µ–ª—å —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–æ–∫–µ–Ω, –Ω–æ –Ω–µ—Ç displayName (–æ–±—ã—á–Ω–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∞–Ω–æ–Ω–∏–º–Ω–æ–º –≤—Ö–æ–¥–µ)
                        if (!user.displayName && !initialAuthToken) {

// –ü—Ä–æ—Å–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∏–∫–Ω–µ–π–º
                            updateUserInfoUI(user); 
                        } else {
                            // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω –∏ –∏–º–µ–µ—Ç –Ω–∏–∫–Ω–µ–π–º (–∏–ª–∏ —Ç–æ–∫–µ–Ω –±—ã–ª –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω)
                            updateUserInfoUI(user);
                            isAuthReady = true;
                            // –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
                            setupFirestoreListeners();
                        }
                    } else {
                        // –ï—Å–ª–∏ –Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∏–ª–∏ –≤—ã—Ö–æ–¥), –ø—ã—Ç–∞–µ–º—Å—è –≤–æ–π—Ç–∏ –∞–Ω–æ–Ω–∏–º–Ω–æ
                        await handleInitialAuth();
                    }
                    
                    // –ì–ê–†–ê–ù–¢–ò–Ø –î–û–°–¢–£–ü–ù–û–°–¢–ò UI (–¥–∞–∂–µ –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã)
                    showLoading(false); 
                });

                // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å —Ç–æ–∫–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –¥–ª—è –≤—Ö–æ–¥–∞
                if (initialAuthToken) {
                    await handleInitialAuth();
                } 

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ
                switchView('profiles'); 
                
            } catch (error) {
                console.error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase:", error);
                showMessage("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–∏—Å—É –¥–∞–Ω–Ω—ã—Ö.", "–æ—à–∏–±–∫–∞");
                showLoading(false);
            }
        }

        /**
         * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—É—é –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é (Custom Token –∏–ª–∏ –ê–Ω–æ–Ω–∏–º–Ω–æ).
         */
        async function handleInitialAuth() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                 // –ï—Å–ª–∏ signInWithCustomToken –Ω–µ —É–¥–∞–ª—Å—è, –ø—Ä–æ–±—É–µ–º –∞–Ω–æ–Ω–∏–º–Ω—ã–π
                console.warn("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞ —Å —Ç–æ–∫–µ–Ω–æ–º. –ü–æ–ø—ã—Ç–∫–∞ –∞–Ω–æ–Ω–∏–º–Ω–æ–≥–æ –≤—Ö–æ–¥–∞.", error);
                try {
                    await signInAnonymously(auth);
                } catch (anonError) {
                    console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–π—Ç–∏ –∞–Ω–æ–Ω–∏–º–Ω–æ:", anonError);
                }
            }
        }

        /**
         * –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç —Å–ª—É—à–∞—Ç–µ–ª–µ–π Firestore –¥–ª—è —á–∞—Ç–∞ –∏ –∞–Ω–∫–µ—Ç.
         */
        function setupFirestoreListeners() {
            if (!isAuthReady) return;

            // 1. –°–ª—É—à–∞—Ç–µ–ª—å –¥–ª—è –∞–Ω–∫–µ—Ç
            const profilesQuery = query(collection(db, PUBLIC_PROFILES_COLLECTION));
            onSnapshot(profilesQuery, (snapshot) => {
                const profiles = [];
                snapshot.forEach(doc => {
                    profiles.push({ id: doc.id, ...doc.data() });
                });
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –≤ –ø–∞–º—è—Ç–∏ –ø–æ –¥–∞—Ç–µ (—Å–∞–º—ã–µ –Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
                profiles.sort((a, b) => b.createdAt?.seconds - a.createdAt?.seconds);
                renderProfiles(profiles);
            }, (error) => {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è –∞–Ω–∫–µ—Ç:", error);
                showMessage("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–Ω–∫–µ—Ç—ã.", "–æ—à–∏–±–∫–∞");
            });

            // 2. –°–ª—É—à–∞—Ç–µ–ª—å –¥–ª—è —á–∞—Ç–∞
            // –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Å–æ–æ–±—â–µ–Ω–∏–π
            const chatQuery = query(collection(db, PUBLIC_CHAT_COLLECTION), 
                                    // orderBy('createdAt'), // Firestore —Ç—Ä–µ–±—É–µ—Ç –∏–Ω–¥–µ–∫—Å –¥–ª—è —ç—Ç–æ–≥–æ, —Å–æ—Ä—Ç–∏—Ä—É–µ–º –≤ –ø–∞–º—è—Ç–∏
                                    limit(50)); 
            
            onSnapshot(chatQuery, (snapshot) => {
                chatMessages.innerHTML = '';
                const messages = [];
                snapshot.forEach(doc => {
                    messages.push({ id: doc.id, ...doc.data() });
                });
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –≤ –ø–∞–º—è—Ç–∏ –ø–æ –¥–∞—Ç–µ (—Å–∞–º—ã–µ —Å—Ç–∞—Ä—ã–µ —Å–≤–µ—Ä—Ö—É –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ—Ä—è–¥–∫–∞ –≤ —á–∞—Ç–µ)
                messages.sort((a, b) => a.createdAt?.seconds - b.createdAt?.seconds);

messages.forEach(message => renderMessage(message));
                
                // –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                document.getElementById('no-chat-message').classList.toggle('hidden', messages.length > 0);

            }, (error) => {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è —á–∞—Ç–∞:", error);
                showMessage("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è —á–∞—Ç–∞.", "–æ—à–∏–±–∫–∞");
            });
        }

        // --- 7. –°–õ–£–®–ê–¢–ï–õ–ò DOM-–°–û–ë–´–¢–ò–ô ---

        navButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                // –†–∞–∑—Ä–µ—à–∞–µ–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
                if (isAuthReady) {
                    switchView(btn.dataset.view);
                } else {
                    showMessage("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–∞–≤–∏–≥–∞—Ü–∏—é.", "–∏–Ω—Ñ–æ");
                }
            });
        });

        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        window.onload = initApp;

    </script>
</body>
</html>
