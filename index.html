<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Стартовое приложение Firebase</title>
    <!-- Загрузка Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Пользовательская полоса прокрутки для списка сообщений */
        .message-list::-webkit-scrollbar {
            width: 8px;
        }
        .message-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .message-list::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .message-list::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-4 font-sans">

    <div id="app-container" class="w-full max-w-xl bg-white shadow-2xl rounded-xl p-6 md:p-8 space-y-6">
        <h1 class="text-3xl font-bold text-center text-indigo-700">Демонстрация Firestore в реальном времени</h1>
        
        <div class="space-y-2 text-sm md:text-base">
            <p id="status" class="font-medium text-center text-sm text-yellow-600 bg-yellow-100 p-2 rounded-lg">Инициализация Firebase...</p>
            <p id="user-id" class="text-center break-all text-gray-500">Ожидание аутентификации...</p>
        </div>

        <!-- Поле ввода сообщения -->
        <div class="flex flex-col space-y-3">
            <input type="text" id="message-input" placeholder="Введите публичное сообщение..."
                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
            <button id="send-button" onclick="sendMessage()" disabled
                    class="bg-indigo-600 text-white font-semibold py-3 rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 disabled:bg-indigo-300">
                Сохранить сообщение в Firestore
            </button>
        </div>

        <!-- Список сообщений -->
        <div class="space-y-3">
            <h2 class="text-xl font-semibold text-gray-700 border-b pb-2">Публичные сообщения (в реальном времени)</h2>
            <div id="messages-list" class="message-list h-64 overflow-y-auto bg-gray-50 p-3 rounded-lg border border-gray-200 space-y-2">
                <!-- Сообщения будут внедрены здесь -->
                <p class="text-gray-400 text-center py-4">Загрузка сообщений...</p>
            </div>
        </div>
    </div>

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setDoc, addDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ И НАСТРОЙКА FIREBASE ---
        
        // ЖЕСТКО ПРОПИСАННАЯ КОНФИГУРАЦИЯ (для исправления ошибки)
        const userFirebaseConfig = {
            apiKey: "AIzaSyA7EumEru2qfYcAyxAWLL4TY_dWfcU3Dfg",
            authDomain: "linkmeetcraft.firebaseapp.com",
            projectId: "linkmeetcraft",
            storageBucket: "linkmeetcraft.firebasestorage.app",
            messagingSenderId: "373052253470",
            appId: "1:373052253470:web:a66afc67876f76dc1a550f",
            measurementId: "G-WSZL0NRHCQ"
        };

        // Используем глобальные переменные среды, если они доступны,
        // но приоритет отдаем жестко прописанной конфигурации, если среда не предоставила ее корректно.
        const appId = typeof __app_id !== 'undefined' ? __app_id : userFirebaseConfig.projectId || 'default-app-id';
        const firebaseConfig = userFirebaseConfig; // Используем жестко прописанную
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        // Выставляем функции в глобальную область видимости для доступа из HTML
        window.sendMessage = sendMessage;

        const getCollectionPath = () => `/artifacts/${appId}/public/data/messages`;

        const setupFirebase = async () => {
            const statusEl = document.getElementById('status');
            const userIdEl = document.getElementById('user-id');
            const sendButton = document.getElementById('send-button');

            try {
                // 1. Инициализация сервисов Firebase
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug'); // Включаем логирование для отладки

                // 2. Аутентификация
                await setPersistence(auth, browserSessionPersistence);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    statusEl.textContent = 'Статус: Аутентификация с токеном...';
                } else {
                    await signInAnonymously(auth);
                    statusEl.textContent = 'Статус: Анонимная аутентификация...';
                }

                // 3. Слушатель состояния аутентификации
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdEl.textContent = `Текущий ID Пользователя: ${userId}`;
                        statusEl.textContent = 'Статус: Аутентифицирован и готов';
                        sendButton.disabled = false;
                        isAuthReady = true;
                        
                        // Начинаем слушать данные после аутентификации
                        listenForMessages();
                    } else {
                        // Резервный вариант, если аутентификация не удалась
                        userId = crypto.randomUUID(); 
                        userIdEl.textContent = `ID (Резервный анонимный): ${userId}`;
                        statusEl.textContent = 'Статус: Не аутентифицирован (Анонимный режим)';
                        sendButton.disabled = true;
                        isAuthReady = false;
                    }
                });

            } catch (error) {
                console.error("Сбой инициализации или аутентификации Firebase:", error);
                statusEl.textContent = `Ошибка Auth: ${error.message}`;
                // Если сбой, показываем, что конфигурация, возможно, неверна
                if (error.code === 'auth/invalid-api-key') {
                    statusEl.textContent = 'КРИТИЧЕСКАЯ ОШИБКА: Неверный API-ключ. Проверьте конфигурацию!';
                }
            }
        };

        // --- ФУНКЦИИ FIRESTORE ---

        // Функция отправки сообщения
        async function sendMessage() {
            if (!isAuthReady || !userId || !db) {
                console.error("Firebase не готов или пользователь не аутентифицирован.");
                document.getElementById('status').textContent = 'Ошибка: Не готов к отправке данных.';
                return;
            }

            const messageInput = document.getElementById('message-input');
            const messageText = messageInput.value.trim();

            if (messageText === "") {
                messageInput.focus();
                return;
            }

            const newMessage = {
                text: messageText,
                userId: userId, // ID аутентифицированного пользователя
                timestamp: serverTimestamp() // Временная метка сервера Firestore
            };

            try {
                // Добавляем новое сообщение в публичную коллекцию
                await addDoc(collection(db, getCollectionPath()), newMessage);
                messageInput.value = ''; // Очищаем поле ввода при успехе
                console.log("Документ успешно записан!");

            } catch (e) {
                console.error("Ошибка при добавлении документа: ", e);
                document.getElementById('status').textContent = `Ошибка сохранения: ${e.message}`;
            }
        }

        // Функция для прослушивания изменений в реальном времени
        function listenForMessages() {
            if (!isAuthReady || !db) {
                console.error("Невозможно прослушивать сообщения: DB или Auth не готовы.");
                return;
            }

            const messagesList = document.getElementById('messages-list');
            const q = collection(db, getCollectionPath());
            
            // Используем только запрос коллекции. Сортировку выполняем в памяти
            const messagesQuery = query(q);

            // Настройка слушателя в реальном времени
            onSnapshot(messagesQuery, (snapshot) => {
                let messages = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    messages.push({ ...data, id: doc.id });
                });
                
                // Сортируем вручную по времени (от нового к старому)
                messages.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

                renderMessages(messages, messagesList);
            }, (error) => {
                console.error("Ошибка прослушивания сообщений:", error);
                messagesList.innerHTML = `<p class="text-red-500 text-center py-4">Ошибка загрузки сообщений: ${error.message}</p>`;
            });
        }

        // Функция для рендеринга сообщений в UI
        function renderMessages(messages, container) {
            container.innerHTML = '';
            if (messages.length === 0) {
                container.innerHTML = `<p class="text-gray-400 text-center py-4">Сообщений пока нет. Будьте первым!</p>`;
                return;
            }

            messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                const isUser = msg.userId === userId;
                
                // Форматирование временной метки
                let time = 'Сохранение...';
                if (msg.timestamp && msg.timestamp.toDate) {
                    time = msg.timestamp.toDate().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                }

                messageDiv.className = `p-3 rounded-xl shadow-sm max-w-[90%] ${isUser ? 'bg-indigo-100 self-end ml-auto' : 'bg-white border border-gray-200 mr-auto'}`;
                
                messageDiv.innerHTML = `
                    <p class="text-gray-800 break-words">${msg.text}</p>
                    <div class="mt-1 text-xs ${isUser ? 'text-indigo-600' : 'text-gray-500'} flex justify-between">
                        <span class="font-semibold">${isUser ? 'Вы' : `Пользователь: ${msg.userId.substring(0, 8)}...`}</span>
                        <span class="ml-2">${time}</span>
                    </div>
                `;
                container.appendChild(messageDiv);
            });
            // Прокрутка вниз, чтобы показать последнее сообщение
            container.scrollTop = container.scrollHeight;
        }

        // Запуск настройки приложения
        window.addEventListener('load', setupFirebase);
    </script>
</body>
</html>
