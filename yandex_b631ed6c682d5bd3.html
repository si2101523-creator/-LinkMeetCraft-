// --- КОНФИГУРАЦИЯ FIREBASE ---
// ВАЖНО: Замените значения ниже на реальные переменные из вашего окружения (Canvas)
const userFirebaseConfig = {
    // Вставьте вашу реальную конфигурацию Firebase здесь
};

// Переменные окружения Canvas (если они определены)
const appId = typeof __app_id !== 'undefined' ? __app_id : userFirebaseConfig.projectId || 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : userFirebaseConfig;
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// Глобальные переменные
let app;
let db;
let auth;
let userId = null;
let userName = 'Аноним'; // Имя по умолчанию
let isAuthReady = false;

// --- FIRESTORE PATHS ---
const getChatCollectionPath = () => `/artifacts/${appId}/public/data/chat_messages`;
const getTodoCollectionPath = (uid) => `/artifacts/${appId}/users/${uid}/todos`; // Личные задачи
const getUserDocPath = (uid) => `/artifacts/${appId}/public/data/user_profiles/${uid}`; // Публичный профиль

// --- ИНИЦИАЛИЗАЦИЯ И АУТЕНТИФИКАЦИЯ (i3) ---

import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, setDoc, addDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const setupFirebase = async () => {
    // Получение элементов, если они существуют в DOM
    const statusEl = document.getElementById('status-message');
    const userIdEl = document.getElementById('user-id-display');
    const sendButton = document.getElementById('send-message-btn');
    const saveUsernameButton = document.getElementById('save-username-btn');
    const addTodoButton = document.getElementById('add-todo-btn');

    const updateUIElements = (isDisabled) => {
        if (sendButton) sendButton.disabled = isDisabled;
        if (saveUsernameButton) saveUsernameButton.disabled = isDisabled;
        if (addTodoButton) addTodoButton.disabled = isDisabled;
    };

    try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        setLogLevel('Debug');

        await setPersistence(auth, browserSessionPersistence);
        
        if (initialAuthToken) {
            await signInWithCustomToken(auth, initialAuthToken);
        } else {
            await signInAnonymously(auth);
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                if (userIdEl) userIdEl.textContent = `Ваш ID: ${userId}`;
                if (statusEl) statusEl.textContent = 'Статус: Аутентифицирован и готов';
                updateUIElements(false);
                isAuthReady = true;
                
                // Запуск слушателей после успешной аутентификации
                listenForUsername(); 
                listenForMessages();
                listenForTodos();
            } else {
                userId = crypto.randomUUID(); 
                if (userIdEl) userIdEl.textContent = `ID (Анонимный): ${userId}`;
                if (statusEl) statusEl.textContent = 'Статус: Не аутентифицирован (Анонимный режим)';
                updateUIElements(true);
                isAuthReady = false;
            }
        });

    } catch (error) {
        console.error("Firebase Initialization or Authentication failed:", error);
        if (statusEl) statusEl.textContent = `Ошибка Auth: ${error.message}`;
    }
};


// --- ФУНКЦИИ ПРОФИЛЯ ПОЛЬЗОВАТЕЛЯ (i3) ---

// Загрузка имени пользователя
function listenForUsername() {
    if (!isAuthReady || !db || !userId) return;

    const usernameInput = document.getElementById('username-input');
    const userDocRef = doc(db, getUserDocPath(userId));

    onSnapshot(userDocRef, (docSnapshot) => {
        if (docSnapshot.exists()) {
            const data = docSnapshot.data();
            if (data.username) {
                userName = data.username;
                if (usernameInput) usernameInput.value = userName;
                console.log(`Имя пользователя загружено: ${userName}`);
            }
        }
    }, (error) => {
        console.error("Ошибка загрузки имени пользователя:", error);
    });
}

// Сохранение имени пользователя
window.saveUsername = async function() {
    if (!isAuthReady || !userId || !db) return;

    const usernameInput = document.getElementById('username-input');
    const statusEl = document.getElementById('status-message');
    const newUsername = usernameInput ? usernameInput.value.trim() : '';
    
    if (newUsername === "") {
        if (statusEl) statusEl.textContent = 'Пожалуйста, введите имя пользователя.';
        return;
    }

    const userDocRef = doc(db, getUserDocPath(userId));
    try {
        await setDoc(userDocRef, { 
            username: newUsername, 
            lastUpdated: serverTimestamp() 
        }, { merge: true });
        userName = newUsername; 
        if (statusEl) statusEl.textContent = `Статус: Имя "${userName}" успешно сохранено!`;
    } catch (e) {
        console.error("Error saving username: ", e);
        if (statusEl) statusEl.textContent = `Ошибка сохранения имени: ${e.message}`;
    }
}


// --- ФУНКЦИИ ЧАТА (i1) ---

// Отправка публичного сообщения
window.sendMessage = async function() {
    if (!isAuthReady || !userId || !db) return;

    const messageInput = document.getElementById('message-input');
    const messageText = messageInput ? messageInput.value.trim() : '';

    if (messageText === "") {
        if (messageInput) messageInput.focus();
        return;
    }

    const newMessage = {
        text: messageText,
        userId: userId,
        username: userName,
        timestamp: serverTimestamp()
    };

    try {
        await addDoc(collection(db, getChatCollectionPath()), newMessage);
        if (messageInput) messageInput.value = '';
    } catch (e) {
        console.error("Error adding document to chat: ", e);
        const statusEl = document.getElementById('status-message');
        if (statusEl) statusEl.textContent = `Ошибка чата: ${e.message}`;
    }
}

// Слушатель для сообщений чата в реальном времени
function listenForMessages() {
    if (!isAuthReady || !db) return;

    const messagesList = document.getElementById('messages-list');
    if (!messagesList) return;

    const q = collection(db, getChatCollectionPath());
    const messagesQuery = query(q);

    onSnapshot(messagesQuery, (snapshot) => {
        let messages = [];
        snapshot.forEach((doc) => {
            const data = doc.data();
            messages.push({ ...data, id: doc.id });
        });
        
        // Сортировка по времени (новые сообщения внизу списка)
        messages.sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));

        renderMessages(messages, messagesList);
    }, (error) => {
        console.error("Error listening to chat messages:", error);
        messagesList.innerHTML = `<p style="color:red; text-align:center;">Ошибка загрузки чата: ${error.message}</p>`;
    });
}

// Отображение сообщений
function renderMessages(messages, container) {
    container.innerHTML = '';
    if (messages.length === 0) {
        container.innerHTML = `<p style="color:#9ca3af; text-align:center; padding:10px;">Сообщений пока нет. Начните чат!</p>`;
        return;
    }

    messages.forEach(msg => {
        const messageDiv = document.createElement('div');
        const isUser = msg.userId === userId;
        
        let time = 'Saving...';
        if (msg.timestamp && msg.timestamp.toDate) {
            time = msg.timestamp.toDate().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
        }

        const senderName = msg.username || 'Аноним';
        
        // Используйте ваши CSS-классы для оформления сообщений здесь
        messageDiv.style.cssText = `
            padding: 8px;
            margin-bottom: 10px;
            border-radius: 12px;
            max-width: 80%;
            word-wrap: break-word;
            ${isUser ? 'background-color: #4f46e5; color: white; margin-left: auto;' : 'background-color: #f3f4f6; color: #1f2937; margin-right: auto;'}
        `;

        messageDiv.innerHTML = `
            <div style="font-weight: bold; font-size: 0.9em; margin-bottom: 3px; color: ${isUser ? '#c7d2fe' : '#4b5563'};">${senderName}</div>
            <p>${msg.text}</p>
            <div style="margin-top: 5px; font-size: 0.75em; text-align: right; color: ${isUser ? '#a5b4fc' : '#9ca3af'};">
                <span>${time}</span>
            </div>
        `;
        container.appendChild(messageDiv);
    });

    // Автоматический скролл вниз
    container.scrollTop = container.scrollHeight;
}


// --- ФУНКЦИИ СПИСКА ДЕЛ (i2) ---

// Добавление задачи
window.addTodo = async function() {
    if (!isAuthReady || !userId || !db) return;

    const todoInput = document.getElementById('todo-input');
    const todoText = todoInput ? todoInput.value.trim() : '';

    if (todoText === "") {
        if (todoInput) todoInput.focus();
        return;
    }

    const newTodo = {
        text: todoText,
        completed: false,
        createdAt: serverTimestamp()
    };

    try {
        await addDoc(collection(db, getTodoCollectionPath(userId)), newTodo);
        if (todoInput) todoInput.value = '';
    } catch (e) {
        console.error("Error adding todo: ", e);
        const statusEl = document.getElementById('status-message');
        if (statusEl) statusEl.textContent = `Ошибка задач: ${e.message}`;
    }
}

// Переключение статуса задачи
window.toggleTodo = async function(id, completedStatus) {
    if (!isAuthReady || !userId || !db) return;

    const todoDocRef = doc(db, getTodoCollectionPath(userId), id);
    try {
        await updateDoc(todoDocRef, {
            completed: !completedStatus
        });
    } catch (e) {
        console.error("Error toggling todo status: ", e);
    }
}

// Удаление задачи
window.deleteTodo = async function(id) {
    if (!isAuthReady || !userId || !db) return;

    const todoDocRef = doc(db, getTodoCollectionPath(userId), id);
    try {
        await deleteDoc(todoDocRef);
    } catch (e) {
        console.error("Error deleting todo: ", e);
    }
}

// Слушатель для списка дел в реальном времени
function listenForTodos() {
    if (!isAuthReady || !db || !userId) return;

    const todoListEl = document.getElementById('todo-list');
    if (!todoListEl) return;

    const q = collection(db, getTodoCollectionPath(userId));
    const todosQuery = query(q);

    onSnapshot(todosQuery, (snapshot) => {
        let todos = [];
        snapshot.forEach((doc) => {
            const data = doc.data();
            todos.push({ ...data, id: doc.id });
        });
        
        // Сортировка (завершенные в конце)
        todos.sort((a, b) => {
            if (a.completed !== b.completed) {
                return a.completed ? 1 : -1;
            }
            return (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0);
        });

        renderTodos(todos, todoListEl);
    }, (error) => {
        console.error("Error listening to todo list:", error);
        todoListEl.innerHTML = `<p style="color:red; text-align:center; padding:10px;">Ошибка загрузки задач: ${error.message}</p>`;
    });
}

// Отображение задач
function renderTodos(todos, container) {
    container.innerHTML = '';
    if (todos.length === 0) {
        container.innerHTML = `<p style="color:#9ca3af; text-align:center; padding:10px;">Задач пока нет. Добавьте первую!</p>`;
        return;
    }

    todos.forEach(todo => {
        const itemDiv = document.createElement('div');
        const textStyle = todo.completed ? 'text-decoration: line-through; color: #9ca3af;' : 'color: #1f2937;';

        // Используйте ваши CSS-классы и стили здесь
        itemDiv.style.cssText = `
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            margin-bottom: 5px;
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        `;
        
        itemDiv.innerHTML = `
            <div style="display: flex; align-items: center; flex-grow: 1;">
                <!-- Кнопка/Чекбокс -->
                <button onclick="toggleTodo('${todo.id}', ${todo.completed})"
                        style="width: 24px; height: 24px; border-radius: 50%; border: 2px solid ${todo.completed ? '#10b981' : '#6b7280'}; background-color: ${todo.completed ? '#10b981' : 'transparent'}; margin-right: 10px; cursor: pointer; display: flex; justify-content: center; align-items: center;">
                    ${todo.completed ? '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>' : ''}
                </button>
                
                <!-- Текст задачи -->
                <p style="flex-grow: 1; font-weight: 500; ${textStyle}">${todo.text}</p>
            </div>

            <!-- Кнопка Удалить -->
            <button onclick="deleteTodo('${todo.id}')"
                    style="color: #ef4444; margin-left: 10px; cursor: pointer; border: none; background: none;"
                    title="Удалить задачу">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
            </button>
        `;
        container.appendChild(itemDiv);
    });
}


// Запуск скрипта при загрузке страницы
window.addEventListener('load', setupFirebase);
